import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addZero, convertDateToISOExtended } from '../../utils/util';
export class PoPageJobSchedulerService {
    constructor(http) {
        this.http = http;
        this.endpoint = '/';
        this.headers = new HttpHeaders({
            'X-PO-SCREEN-LOCK': 'true'
        });
    }
    configServiceApi(config = {}) {
        this.endpoint = config.endpoint;
    }
    // Cria um recurso
    createResource(resource) {
        const jobScheduler = this.convertToJobScheduler(resource);
        return this.http.post(`${this.endpoint}`, jobScheduler, { headers: this.headers });
    }
    getHeadProcesses() {
        const headers = { 'X-PO-No-Error': 'true' };
        return this.http.head(`${this.endpoint}/processes`, { headers });
    }
    // Busca parametros pelo processo id
    getParametersByProcess(processId) {
        return this.http
            .get(`${this.endpoint}/processes/${processId}/parameters`, { headers: this.headers })
            .pipe(map((resource) => resource.items));
    }
    // Busca um único recurso
    getProcess(id) {
        return this.http.get(`${this.endpoint}/processes/${id}`, { headers: this.headers });
    }
    // Busca uma lista de processos
    getProcesses(params = {}) {
        return this.http.get(`${this.endpoint}/processes`, { params });
    }
    // Busca um único recurso
    getResource(id) {
        return this.http
            .get(`${this.endpoint}/${id}`, { headers: this.headers })
            .pipe(map(resource => this.convertToJobSchedulerInternal(resource)));
    }
    // Atualiza um recurso
    updateResource(id, resource) {
        const jobScheduler = this.convertToJobScheduler(resource);
        return this.http.put(`${this.endpoint}/${id}`, jobScheduler, { headers: this.headers });
    }
    convertToJobScheduler(jobSchedulerInternal) {
        const jobScheduler = Object.assign({}, jobSchedulerInternal);
        if (jobSchedulerInternal.periodicity) {
            if (jobSchedulerInternal.periodicity === 'single') {
                jobScheduler.recurrent = false;
            }
            else {
                Object.assign(jobScheduler, this.convertToPeriodicity(jobSchedulerInternal));
            }
        }
        if (jobSchedulerInternal.firstExecutionHour) {
            jobScheduler.firstExecution = this.replaceHourFirstExecution(jobSchedulerInternal.firstExecution, jobSchedulerInternal.firstExecutionHour);
        }
        if (!Object.keys(this.returnValidExecutionParameter(jobScheduler.executionParameter)).length) {
            delete jobScheduler.executionParameter;
        }
        this.removeInvalidKeys(jobScheduler);
        return jobScheduler;
    }
    convertToJobSchedulerInternal(jobScheduler = {}) {
        const jobSchedulerInternal = Object.assign({}, jobScheduler);
        if (jobScheduler.firstExecution) {
            jobSchedulerInternal.firstExecutionHour = this.getHourFirstExecution(jobScheduler.firstExecution);
        }
        Object.assign(jobSchedulerInternal, this.convertToPeriodicityInternal(jobScheduler));
        this.removeInvalidKeys(jobSchedulerInternal, ['weekly', 'monthly', 'daily']);
        return jobSchedulerInternal;
    }
    convertToPeriodicity(value) {
        const newValue = {};
        const valuePeriodicity = value.periodicity;
        if (valuePeriodicity) {
            newValue[valuePeriodicity] = {};
            if (valuePeriodicity === 'monthly') {
                newValue[valuePeriodicity].day = value.dayOfMonth ? parseInt(value.dayOfMonth, 10) : 0;
            }
            else if (valuePeriodicity === 'weekly') {
                newValue[valuePeriodicity].daysOfWeek = value.daysOfWeek;
            }
            newValue[valuePeriodicity].hour = value.hour ? parseInt(value.hour.split(':')[0], 10) : 0;
            newValue[valuePeriodicity].minute = value.hour ? parseInt(value.hour.split(':')[1], 10) : 0;
        }
        return newValue;
    }
    convertToPeriodicityInternal(value = {}) {
        if (value.monthly) {
            return {
                periodicity: 'monthly',
                hour: `${addZero(value.monthly.hour)}:${addZero(value.monthly.minute)}`,
                dayOfMonth: value.monthly.day
            };
        }
        else if (value.daily) {
            return {
                periodicity: 'daily',
                hour: `${addZero(value.daily.hour)}:${addZero(value.daily.minute)}`
            };
        }
        else if (value.weekly) {
            return {
                periodicity: 'weekly',
                hour: `${addZero(value.weekly.hour)}:${addZero(value.weekly.minute)}`,
                daysOfWeek: [...value.weekly.daysOfWeek]
            };
        }
        else {
            return {
                periodicity: 'single'
            };
        }
    }
    getCurrentHour(date) {
        const hours = addZero(date.getHours());
        const minutes = addZero(date.getMinutes());
        return `${hours}:${minutes}`;
    }
    getHourFirstExecution(firstExecutionDate) {
        return this.getCurrentHour(new Date(firstExecutionDate));
    }
    removeInvalidKeys(value, keys) {
        const invalidKeys = keys || [
            'periodicity',
            'hour',
            'minute',
            'day',
            'daysOfWeek',
            'dayOfMonth',
            'firstExecutionHour'
        ];
        Object.keys(value).forEach(key => {
            if (invalidKeys.includes(key)) {
                delete value[key];
            }
        });
    }
    replaceHourFirstExecution(date, time) {
        const firstExecutionDate = new Date(date);
        const timeSplited = time.split(':');
        const hours = parseInt(timeSplited[0], 10);
        const minutes = parseInt(timeSplited[1], 10);
        firstExecutionDate.setHours(hours, minutes);
        return convertDateToISOExtended(firstExecutionDate);
    }
    returnValidExecutionParameter(parameter) {
        const newParameter = Object.assign({}, parameter);
        for (const key in newParameter) {
            if (newParameter.hasOwnProperty(key) && newParameter[key] === undefined) {
                delete newParameter[key];
            }
        }
        return newParameter;
    }
}
PoPageJobSchedulerService.decorators = [
    { type: Injectable }
];
PoPageJobSchedulerService.ctorParameters = () => [
    { type: HttpClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcGFnZS1qb2Itc2NoZWR1bGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy90ZW1wbGF0ZXMvc3JjL2xpYi9jb21wb25lbnRzL3BvLXBhZ2Utam9iLXNjaGVkdWxlci9wby1wYWdlLWpvYi1zY2hlZHVsZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQU9yRSxNQUFNLE9BQU8seUJBQXlCO0lBT3BDLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFONUIsYUFBUSxHQUFHLEdBQUcsQ0FBQztRQUVkLFlBQU8sR0FBZ0IsSUFBSSxXQUFXLENBQUM7WUFDOUMsa0JBQWtCLEVBQUUsTUFBTTtTQUMzQixDQUFDLENBQUM7SUFFb0MsQ0FBQztJQUV4QyxnQkFBZ0IsQ0FBQyxTQUFnQyxFQUFFO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNsQyxDQUFDO0lBRUQsa0JBQWtCO0lBQ2xCLGNBQWMsQ0FBQyxRQUFRO1FBQ3JCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUxRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFlBQVksRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUNyRixDQUFDO0lB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LElBQVk7UUFDMUQsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUxQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXBDLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0MsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUU3QyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRTVDLE9BQU8sd0JBQXdCLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRU8sNkJBQTZCLENBQUMsU0FBaUI7UUFDckQsTUFBTSxZQUFZLHFCQUFRLFNBQVMsQ0FBRSxDQUFDO1FBRXRDLEtBQUssTUFBTSxHQUFHLElBQUksWUFBWSxFQUFFO1lBQzlCLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxZQUFZLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxFQUFFO2dCQUN2RSxPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxQjtTQUNGO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQzs7O1lBek1GLFVBQVU7OztZQVpGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBhZGRaZXJvLCBjb252ZXJ0RGF0ZVRvSVNPRXh0ZW5kZWQgfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1GaWVsZCB9IGZyb20gJ0Bwby11aS9uZy1jb21wb25lbnRzJztcblxuaW1wb3J0IHsgUG9Kb2JTY2hlZHVsZXIgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tam9iLXNjaGVkdWxlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9Kb2JTY2hlZHVsZXJJbnRlcm5hbCB9IGZyb20gJy4vaW50ZXJmYWNlcy9wby1qb2Itc2NoZWR1bGVyLWludGVybmFsLmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQb1BhZ2VKb2JTY2hlZHVsZXJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBlbmRwb2ludCA9ICcvJztcblxuICByZWFkb25seSBoZWFkZXJzOiBIdHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7XG4gICAgJ1gtUE8tU0NSRUVOLUxPQ0snOiAndHJ1ZSdcbiAgfSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7fVxuXG4gIGNvbmZpZ1NlcnZpY2VBcGkoY29uZmlnOiB7IGVuZHBvaW50Pzogc3RyaW5nIH0gPSB7fSkge1xuICAgIHRoaXMuZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQ7XG4gIH1cblxuICAvLyBDcmlhIHVtIHJlY3Vyc29cbiAgY3JlYXRlUmVzb3VyY2UocmVzb3VyY2UpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGpvYlNjaGVkdWxlciA9IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVyKHJlc291cmNlKTtcblxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdChgJHt0aGlzLmVuZHBvaW50fWAsIGpvYlNjaGVkdWxlciwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSk7XG4gIH1cblxuICBnZXRIZWFkUHJvY2Vzc2VzKCkge1xuICAgIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVBPLU5vLUVycm9yJzogJ3RydWUnIH07XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLmhlYWQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzYCwgeyBoZWFkZXJzIH0pO1xuICB9XG5cbiAgLy8gQnVzY2EgcGFyYW1ldHJvcyBwZWxvIHByb2Nlc3NvIGlkXG4gIGdldFBhcmFtZXRlcnNCeVByb2Nlc3MocHJvY2Vzc0lkOiBzdHJpbmcgfCBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzLyR7cHJvY2Vzc0lkfS9wYXJhbWV0ZXJzYCwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSlcbiAgICAgIC5waXBlKG1hcCgocmVzb3VyY2U6IHsgaXRlbXM6IEFycmF5PFBvRHluYW1pY0Zvcm1GaWVsZD4gfSkgPT4gcmVzb3VyY2UuaXRlbXMpKTtcbiAgfVxuXG4gIC8vIEJ1c2NhIHVtIMO6bmljbyByZWN1cnNvXG4gIGdldFByb2Nlc3MoaWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzLyR7aWR9YCwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSk7XG4gIH1cblxuICAvLyBCdXNjYSB1bWEgbGlzdGEgZGUgcHJvY2Vzc29zXG4gIGdldFByb2Nlc3NlcyhwYXJhbXM6IHt9ID0ge30pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlc2AsIHsgcGFyYW1zIH0pO1xuICB9XG5cbiAgLy8gQnVzY2EgdW0gw7puaWNvIHJlY3Vyc29cbiAgZ2V0UmVzb3VyY2UoaWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLmdldChgJHt0aGlzLmVuZHBvaW50fS8ke2lkfWAsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pXG4gICAgICAucGlwZShtYXAocmVzb3VyY2UgPT4gdGhpcy5jb252ZXJ0VG9Kb2JTY2hlZHVsZXJJbnRlcm5hbChyZXNvdXJjZSkpKTtcbiAgfVxuXG4gIC8vIEF0dWFsaXphIHVtIHJlY3Vyc29cbiAgdXBkYXRlUmVzb3VyY2UoaWQsIHJlc291cmNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBqb2JTY2hlZHVsZXIgPSB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlcihyZXNvdXJjZSk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLnB1dChgJHt0aGlzLmVuZHBvaW50fS8ke2lkfWAsIGpvYlNjaGVkdWxlciwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSk7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRUb0pvYlNjaGVkdWxlcihqb2JTY2hlZHVsZXJJbnRlcm5hbCk6IFBvSm9iU2NoZWR1bGVyIHtcbiAgICBjb25zdCBqb2JTY2hlZHVsZXIgPSB7IC4uLmpvYlNjaGVkdWxlckludGVybmFsIH07XG5cbiAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucGVyaW9kaWNpdHkpIHtcbiAgICAgIGlmIChqb2JTY2hlZHVsZXJJbnRlcm5hbC5wZXJpb2RpY2l0eSA9PT0gJ3NpbmdsZScpIHtcbiAgICAgICAgam9iU2NoZWR1bGVyLnJlY3VycmVudCA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihqb2JTY2hlZHVsZXIsIHRoaXMuY29udmVydFRvUGVyaW9kaWNpdHkoam9iU2NoZWR1bGVySW50ZXJuYWwpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyKSB7XG4gICAgICBqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24gPSB0aGlzLnJlcGxhY2VIb3VyRmlyc3RFeGVjdXRpb24oXG4gICAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uLFxuICAgICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5maXJzdEV4ZWN1dGlvbkhvdXJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKCFPYmplY3Qua2V5cyh0aGlzLnJldHVyblZhbGlkRXhlY3V0aW9uUGFyYW1ldGVyKGpvYlNjaGVkdWxlci5leGVjdXRpb25QYXJhbWV0ZXIpKS5sZW5ndGgpIHtcbiAgICAgIGRlbGV0ZSBqb2JTY2hlZHVsZXIuZXhlY3V0aW9uUGFyYW1ldGVyO1xuICAgIH1cblxuICAgIHRoaXMucmVtb3ZlSW52YWxpZEtleXMoam9iU2NoZWR1bGVyKTtcblxuICAgIHJldHVybiBqb2JTY2hlZHVsZXI7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRUb0pvYlNjaGVkdWxlckludGVybmFsKGpvYlNjaGVkdWxlciA9IDxhbnk+e30pOiBQb0pvYlNjaGVkdWxlckludGVybmFsIHtcbiAgICBjb25zdCBqb2JTY2hlZHVsZXJJbnRlcm5hbCA9IHsgLi4uam9iU2NoZWR1bGVyIH07XG5cbiAgICBpZiAoam9iU2NoZWR1bGVyLmZpcnN0RXhlY3V0aW9uKSB7XG4gICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5maXJzdEV4ZWN1dGlvbkhvdXIgPSB0aGlzLmdldEhvdXJGaXJzdEV4ZWN1dGlvbihqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24pO1xuICAgIH1cblxuICAgIE9iamVjdC5hc3NpZ24oam9iU2NoZWR1bGVySW50ZXJuYWwsIHRoaXMuY29udmVydFRvUGVyaW9kaWNpdHlJbnRlcm5hbChqb2JTY2hlZHVsZXIpKTtcblxuICAgIHRoaXMucmVtb3ZlSW52YWxpZEtleXMoam9iU2NoZWR1bGVySW50ZXJuYWwsIFsnd2Vla2x5JywgJ21vbnRobHknLCAnZGFpbHknXSk7XG5cbiAgICByZXR1cm4gam9iU2NoZWR1bGVySW50ZXJuYWw7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRUb1BlcmlvZGljaXR5KHZhbHVlOiB7XG4gICAgcGVyaW9kaWNpdHk6IHN0cmluZztcbiAgICBkYXlPZk1vbnRoPzogc3RyaW5nO1xuICAgIGRheXNPZldlZWs/OiBudW1iZXI7XG4gICAgaG91cj86IHN0cmluZztcbiAgfSkge1xuICAgIGNvbnN0IG5ld1ZhbHVlID0ge307XG4gICAgY29uc3QgdmFsdWVQZXJpb2RpY2l0eSA9IHZhbHVlLnBlcmlvZGljaXR5O1xuXG4gICAgaWYgKHZhbHVlUGVyaW9kaWNpdHkpIHtcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldID0ge307XG5cbiAgICAgIGlmICh2YWx1ZVBlcmlvZGljaXR5ID09PSAnbW9udGhseScpIHtcbiAgICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uZGF5ID0gdmFsdWUuZGF5T2ZNb250aCA/IHBhcnNlSW50KHZhbHVlLmRheU9mTW9udGgsIDEwKSA6IDA7XG4gICAgICB9IGVsc2UgaWYgKHZhbHVlUGVyaW9kaWNpdHkgPT09ICd3ZWVrbHknKSB7XG4gICAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLmRheXNPZldlZWsgPSB2YWx1ZS5kYXlzT2ZXZWVrO1xuICAgICAgfVxuXG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5ob3VyID0gdmFsdWUuaG91ciA/IHBhcnNlSW50KHZhbHVlLmhvdXIuc3BsaXQoJzonKVswXSwgMTApIDogMDtcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLm1pbnV0ZSA9IHZhbHVlLmhvdXIgPyBwYXJzZUludCh2YWx1ZS5ob3VyLnNwbGl0KCc6JylbMV0sIDEwKSA6IDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1ZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9QZXJpb2RpY2l0eUludGVybmFsKHZhbHVlID0gPGFueT57fSkge1xuICAgIGlmICh2YWx1ZS5tb250aGx5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwZXJpb2RpY2l0eTogJ21vbnRobHknLFxuICAgICAgICBob3VyOiBgJHthZGRaZXJvKHZhbHVlLm1vbnRobHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5tb250aGx5Lm1pbnV0ZSl9YCxcbiAgICAgICAgZGF5T2ZNb250aDogdmFsdWUubW9udGhseS5kYXlcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh2YWx1ZS5kYWlseSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdkYWlseScsXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUuZGFpbHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5kYWlseS5taW51dGUpfWBcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh2YWx1ZS53ZWVrbHkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBlcmlvZGljaXR5OiAnd2Vla2x5JyxcbiAgICAgICAgaG91cjogYCR7YWRkWmVybyh2YWx1ZS53ZWVrbHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS53ZWVrbHkubWludXRlKX1gLFxuICAgICAgICBkYXlzT2ZXZWVrOiBbLi4udmFsdWUud2Vla2x5LmRheXNPZldlZWtdXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwZXJpb2RpY2l0eTogJ3NpbmdsZSdcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50SG91cihkYXRlOiBEYXRlKTogc3RyaW5nIHtcbiAgICBjb25zdCBob3VycyA9IGFkZFplcm8oZGF0ZS5nZXRIb3VycygpKTtcbiAgICBjb25zdCBtaW51dGVzID0gYWRkWmVybyhkYXRlLmdldE1pbnV0ZXMoKSk7XG5cbiAgICByZXR1cm4gYCR7aG91cnN9OiR7bWludXRlc31gO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRIb3VyRmlyc3RFeGVjdXRpb24oZmlyc3RFeGVjdXRpb25EYXRlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRIb3VyKG5ldyBEYXRlKGZpcnN0RXhlY3V0aW9uRGF0ZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVJbnZhbGlkS2V5cyh2YWx1ZTogb2JqZWN0LCBrZXlzPzogQXJyYXk8c3RyaW5nPikge1xuICAgIGNvbnN0IGludmFsaWRLZXlzID0ga2V5cyB8fCBbXG4gICAgICAncGVyaW9kaWNpdHknLFxuICAgICAgJ2hvdXInLFxuICAgICAgJ21pbnV0ZScsXG4gICAgICAnZGF5JyxcbiAgICAgICdkYXlzT2ZXZWVrJyxcbiAgICAgICdkYXlPZk1vbnRoJyxcbiAgICAgICdmaXJzdEV4ZWN1dGlvbkhvdXInXG4gICAgXTtcblxuICAgIE9iamVjdC5rZXlzKHZhbHVlKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAoaW52YWxpZEtleXMuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICBkZWxldGUgdmFsdWVba2V5XTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVwbGFjZUhvdXJGaXJzdEV4ZWN1dGlvbihkYXRlOiBzdHJpbmcsIHRpbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgZmlyc3RFeGVjdXRpb25EYXRlID0gbmV3IERhdGUoZGF0ZSk7XG5cbiAgICBjb25zdCB0aW1lU3BsaXRlZCA9IHRpbWUuc3BsaXQoJzonKTtcblxuICAgIGNvbnN0IGhvdXJzID0gcGFyc2VJbnQodGltZVNwbGl0ZWRbMF0sIDEwKTtcbiAgICBjb25zdCBtaW51dGVzID0gcGFyc2VJbnQodGltZVNwbGl0ZWRbMV0sIDEwKTtcblxuICAgIGZpcnN0RXhlY3V0aW9uRGF0ZS5zZXRIb3Vycyhob3VycywgbWludXRlcyk7XG5cbiAgICByZXR1cm4gY29udmVydERhdGVUb0lTT0V4dGVuZGVkKGZpcnN0RXhlY3V0aW9uRGF0ZSk7XG4gIH1cblxuICBwcml2YXRlIHJldHVyblZhbGlkRXhlY3V0aW9uUGFyYW1ldGVyKHBhcmFtZXRlcjogb2JqZWN0KSB7XG4gICAgY29uc3QgbmV3UGFyYW1ldGVyID0geyAuLi5wYXJhbWV0ZXIgfTtcblxuICAgIGZvciAoY29uc3Qga2V5IGluIG5ld1BhcmFtZXRlcikge1xuICAgICAgaWYgKG5ld1BhcmFtZXRlci5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIG5ld1BhcmFtZXRlcltrZXldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZGVsZXRlIG5ld1BhcmFtZXRlcltrZXldO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXdQYXJhbWV0ZXI7XG4gIH1cbn1cbiJdfQ==