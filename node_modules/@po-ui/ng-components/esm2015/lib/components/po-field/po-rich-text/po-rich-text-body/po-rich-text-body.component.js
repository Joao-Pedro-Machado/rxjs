import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { isFirefox, isIE, isIEOrEdge, openExternalLink } from './../../../../utils/util';
import { PoKeyCodeEnum } from './../../../../enums/po-key-code.enum';
const poRichTextBodyCommands = [
    'bold',
    'italic',
    'underline',
    'justifyleft',
    'justifycenter',
    'justifyright',
    'justifyfull',
    'insertUnorderedList',
    'Createlink'
];
export class PoRichTextBodyComponent {
    constructor() {
        this.change = new EventEmitter();
        this.commands = new EventEmitter();
        this.selectedLink = new EventEmitter();
        this.shortcutCommand = new EventEmitter();
        this.value = new EventEmitter();
        this.onAnchorClick = event => {
            const { target, ctrlKey, metaKey } = event;
            let url;
            let elementLink;
            if (ctrlKey || metaKey) {
                if (event.path) {
                    event.path.forEach(element => {
                        if (element.nodeName === 'A') {
                            url = element.href;
                            elementLink = element;
                        }
                    });
                }
                else {
                    url = target.attributes.href.value;
                    elementLink = target;
                }
                openExternalLink(url);
                elementLink.classList.remove('po-clickable');
            }
        };
    }
    ngOnInit() {
        this.bodyElement.nativeElement.designMode = 'on';
        // timeout necessário para setar o valor vindo do writeValue do componente principal.
        setTimeout(() => this.updateValueWithModelValue());
    }
    executeCommand(command) {
        this.bodyElement.nativeElement.focus();
        if (typeof command === 'object') {
            if (command.command === 'InsertHTML') {
                const { command: linkCommand, value: { urlLink }, value: { urlLinkText } } = command;
                this.handleCommandLink(linkCommand, urlLink, urlLinkText);
            }
            else {
                document.execCommand(command.command, false, command.value);
            }
        }
        else {
            document.execCommand(command, false, null);
        }
        this.updateModel();
        this.value.emit(this.modelValue);
    }
    linkEditing(event) {
        this.isLinkEditing = !!event;
    }
    onBlur() {
        if (this.modelValue !== this.valueBeforeChange) {
            clearTimeout(this.timeoutChange);
            this.timeoutChange = setTimeout(() => {
                this.change.emit(this.modelValue);
            }, 200);
        }
    }
    focus() {
        this.bodyElement.nativeElement.focus();
    }
    onClick() {
        this.emitSelectionCommands();
    }
    onFocus() {
        this.valueBeforeChange = this.modelValue;
    }
    onKeyDown(event) {
        const keyK = event.keyCode === PoKeyCodeEnum.keyK;
        const isLinkShortcut = (keyK && event.ctrlKey) || (keyK && event.metaKey);
        if (isLinkShortcut) {
            event.preventDefault();
            this.shortcutCommand.emit();
        }
        this.toggleCursorOnLink(event, 'add');
    }
    onKeyUp(event) {
        this.toggleCursorOnLink(event, 'remove');
        this.removeBrElement();
        this.updateModel();
        this.emitSelectionCommands();
    }
    onPaste() {
        this.addClickListenerOnAnchorElements();
        this.update();
    }
    update() {
        setTimeout(() => this.updateModel());
        setTimeout(() => {
            this.removeBrElement();
            this.updateModel();
            this.emitSelectionCommands();
        });
    }
    addClickListenerOnAnchorElements() {
        this.bodyElement.nativeElement.querySelectorAll('a').forEach(element => {
            element.addEventListener('click', this.onAnchorClick);
        });
    }
    emitSelectionCommands() {
        const commands = poRichTextBodyCommands.filter(command => document.queryCommandState(command));
        const rgbColor = document.queryCommandValue('ForeColor');
        let hexColor;
        if (!isIE()) {
            hexColor = this.rgbToHex(rgbColor);
        }
        if (this.isCursorPositionedInALink()) {
            commands.push('Createlink');
        }
        this.selectedLink.emit(this.linkElement); // importante ficar fora do if para emitir mesmo undefined.
        this.commands.emit({ commands, hexColor });
    }
    getTextSelection() {
        const textSelection = document.getSelection();
        if (!textSelection) {
            return;
        }
        const focusNode = textSelection.focusNode ? textSelection.focusNode.parentElement : undefined;
        const anchorNode = textSelection.anchorNode ? textSelection.anchorNode.parentNode : undefined;
        const node = focusNode || anchorNode;
        let tagName;
        if (node) {
            tagName = node['tagName'] || node['nodeName'];
            return {
                node,
                tagName
            };
        }
    }
    handleCommandLink(linkCommand, urlLink, urlLinkText) {
        if (isIE()) {
            this.insertHtmlLinkElement(urlLink, urlLinkText);
        }
        else {
            // '&nbsp;' necessário para o cursor não ficar preso dentro do link no Firefox.
            const linkValue = isFirefox() && !this.isLinkEditing
                ? `&nbsp;${this.makeLinkTag(urlLink, urlLinkText)}&nbsp;`
                : this.makeLinkTag(urlLink, urlLinkText);
            document.execCommand(linkCommand, false, linkValue);
        }
        this.addClickListenerOnAnchorElements();
    }
    // tratamento específico para IE pois não suporta o comando 'insertHTML'.
    insertHtmlLinkElement(urlLink, urlLinkText) {
        const selection = document.getSelection();
        const selectionRange = selection.getRangeAt(0);
        const elementLink = document.createElement('a');
        const elementlinkText = document.createTextNode(urlLinkText);
        elementLink.appendChild(elementlinkText);
        elementLink.href = urlLink;
        elementLink.setAttribute('target', '_blank');
        elementLink.classList.add('po-rich-text-link');
        selectionRange.deleteContents();
        selectionRange.insertNode(elementLink);
    }
    isCursorPositionedInALink() {
        const textSelection = this.getTextSelection();
        this.linkElement = undefined;
        let isLink = false;
        if (textSelection && textSelection.node && textSelection.tagName === 'A') {
            this.linkElement = textSelection.node;
            isLink = true;
        }
        else if ((isFirefox() || isIEOrEdge()) && this.verifyCursorPositionInFirefoxIEEdge()) {
            isLink = true;
        }
        else {
            isLink = textSelection ? this.isParentNodeAnchor(textSelection) : false;
        }
        return isLink;
    }
    isParentNodeAnchor(textSelection) {
        let element = textSelection.node;
        let isLink = false;
        while (element && (element.tagName !== null || element.nodeName !== null)) {
            if (element.tagName === 'A' || element.nodeName === 'A') {
                this.linkElement = element;
                isLink = true;
                return isLink;
            }
            element = element.parentElement || element.parentNode;
        }
        this.linkElement = undefined;
        return isLink;
    }
    makeLinkTag(urlLink, urlLinkText) {
        return `<a class="po-rich-text-link" href="${urlLink}" target="_blank">${urlLinkText || urlLink}</a>`;
    }
    // Tratamento necessário para eliminar a tag <br> criada no firefox quando o body for limpo.
    removeBrElement() {
        const bodyElement = this.bodyElement.nativeElement;
        if (!bodyElement.innerText.trim() && bodyElement.childNodes.length === 1 && bodyElement.querySelector('br')) {
            bodyElement.querySelector('br').remove();
        }
    }
    rgbToHex(rgb) {
        // Tratamento necessário para converter o código rgb para hexadecimal.
        const sep = rgb.indexOf(',') > -1 ? ',' : ' ';
        rgb = rgb.substr(4).split(')')[0].split(sep);
        let r = (+rgb[0]).toString(16);
        let g = (+rgb[1]).toString(16);
        let b = (+rgb[2]).toString(16);
        if (r.length === 1) {
            r = '0' + r;
        }
        if (g.length === 1) {
            g = '0' + g;
        }
        if (b.length === 1) {
            b = '0' + b;
        }
        return '#' + r + g + b;
    }
    toggleCursorOnLink(event, action) {
        const selection = document.getSelection();
        const element = selection.focusNode ? selection.focusNode.parentNode : undefined;
        const isCtrl = event.key === 'Control';
        const isCommand = event.key === 'Meta';
        const isOnCtrlLink = this.isCursorPositionedInALink() && (isCtrl || isCommand);
        if (element) {
            if (isOnCtrlLink) {
                element['classList'][action]('po-clickable');
            }
            else {
                const isClickable = element['classList'] && element['classList'].contains('po-clickable');
                if (isClickable) {
                    element['classList'].remove('po-clickable');
                }
            }
            this.updateModel();
        }
    }
    updateModel() {
        this.modelValue = this.bodyElement.nativeElement.innerHTML;
        this.value.emit(this.modelValue);
    }
    updateValueWithModelValue() {
        if (this.modelValue) {
            this.bodyElement.nativeElement.insertAdjacentHTML('afterbegin', this.modelValue);
        }
    }
    verifyCursorPositionInFirefoxIEEdge() {
        const textSelection = document.getSelection();
        const nodeLink = textSelection.focusNode;
        let isLink = false;
        if (nodeLink && nodeLink.nodeName === 'A') {
            this.linkElement = nodeLink;
            isLink = true;
        }
        else {
            const range = textSelection.getRangeAt(0);
            const fragmentDocument = range.cloneContents();
            const element = fragmentDocument.childNodes[0] || fragmentDocument.firstElementChild;
            this.linkElement = element && element.nodeName === 'A' ? element : undefined;
            isLink = !!this.linkElement;
        }
        return isLink;
    }
}
PoRichTextBodyComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-rich-text-body',
                template: "<div\n  #bodyElement\n  class=\"po-rich-text-body\"\n  tabindex=\"0\"\n  [attr.contenteditable]=\"!readonly\"\n  [attr.data-placeholder]=\"placeholder\"\n  [style.height.px]=\"height\"\n  (blur)=\"onBlur()\"\n  (click)=\"onClick()\"\n  (cut)=\"update()\"\n  (focus)=\"onFocus()\"\n  (keydown)=\"onKeyDown($event)\"\n  (keyup)=\"onKeyUp($event)\"\n  (paste)=\"onPaste()\"\n></div>\n"
            },] }
];
PoRichTextBodyComponent.propDecorators = {
    bodyElement: [{ type: ViewChild, args: ['bodyElement', { static: true },] }],
    height: [{ type: Input, args: ['p-height',] }],
    modelValue: [{ type: Input, args: ['p-model-value',] }],
    placeholder: [{ type: Input, args: ['p-placeholder',] }],
    readonly: [{ type: Input, args: ['p-readonly',] }],
    change: [{ type: Output, args: ['p-change',] }],
    commands: [{ type: Output, args: ['p-commands',] }],
    selectedLink: [{ type: Output, args: ['p-selected-link',] }],
    shortcutCommand: [{ type: Output, args: ['p-shortcut-command',] }],
    value: [{ type: Output, args: ['p-value',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWZpZWxkL3BvLXJpY2gtdGV4dC9wby1yaWNoLXRleHQtYm9keS9wby1yaWNoLXRleHQtYm9keS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBVSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXRHLE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUVyRSxNQUFNLHNCQUFzQixHQUFHO0lBQzdCLE1BQU07SUFDTixRQUFRO0lBQ1IsV0FBVztJQUNYLGFBQWE7SUFDYixlQUFlO0lBQ2YsY0FBYztJQUNkLGFBQWE7SUFDYixxQkFBcUI7SUFDckIsWUFBWTtDQUNiLENBQUM7QUFNRixNQUFNLE9BQU8sdUJBQXVCO0lBSnBDO1FBb0JzQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUUvQixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUU5QixpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFcEMsb0JBQWUsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXJELFVBQUssR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBNE0zQyxrQkFBYSxHQUFHLEtBQUssQ0FBQyxFQUFFO1lBQzlCLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEtBQUssQ0FBQztZQUMzQyxJQUFJLEdBQUcsQ0FBQztZQUNSLElB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SUFBSSxRQUFRLENBQUMsUUFBUSxLQUFLLEdBQUcsRUFBRTtZQUN6QyxJQUFJLENBQUMsV0FBVyxHQUFHLFFBQVEsQ0FBQztZQUM1QixNQUFNLEdBQUcsSUFBSSxDQUFDO1NBQ2Y7YUFBTTtZQUNMLE1BQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUMsTUFBTSxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDL0MsTUFBTSxPQUFPLEdBQUcsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDO1lBRXJGLElBQUksQ0FBQyxXQUFXLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxRQUFRLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUM3RSxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7U0FDN0I7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOzs7WUFoVkYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxtQkFBbUI7Z0JBQzdCLHlZQUFpRDthQUNsRDs7OzBCQU9FLFNBQVMsU0FBQyxhQUFhLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO3FCQUV6QyxLQUFLLFNBQUMsVUFBVTt5QkFFaEIsS0FBSyxTQUFDLGVBQWU7MEJBRXJCLEtBQUssU0FBQyxlQUFlO3VCQUVyQixLQUFLLFNBQUMsWUFBWTtxQkFFbEIsTUFBTSxTQUFDLFVBQVU7dUJBRWpCLE1BQU0sU0FBQyxZQUFZOzJCQUVuQixNQUFNLFNBQUMsaUJBQWlCOzhCQUV4QixNQUFNLFNBQUMsb0JBQW9CO29CQUUzQixNQUFNLFNBQUMsU0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25Jbml0LCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBpc0ZpcmVmb3gsIGlzSUUsIGlzSUVPckVkZ2UsIG9wZW5FeHRlcm5hbExpbmsgfSBmcm9tICcuLy4uLy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9LZXlDb2RlRW51bSB9IGZyb20gJy4vLi4vLi4vLi4vLi4vZW51bXMvcG8ta2V5LWNvZGUuZW51bSc7XG5cbmNvbnN0IHBvUmljaFRleHRCb2R5Q29tbWFuZHMgPSBbXG4gICdib2xkJyxcbiAgJ2l0YWxpYycsXG4gICd1bmRlcmxpbmUnLFxuICAnanVzdGlmeWxlZnQnLFxuICAnanVzdGlmeWNlbnRlcicsXG4gICdqdXN0aWZ5cmlnaHQnLFxuICAnanVzdGlmeWZ1bGwnLFxuICAnaW5zZXJ0VW5vcmRlcmVkTGlzdCcsXG4gICdDcmVhdGVsaW5rJ1xuXTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tcmljaC10ZXh0LWJvZHknLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvUmljaFRleHRCb2R5Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgcHJpdmF0ZSBpc0xpbmtFZGl0aW5nOiBib29sZWFuO1xuICBwcml2YXRlIGxpbmtFbGVtZW50OiBhbnk7XG4gIHByaXZhdGUgdGltZW91dENoYW5nZTogYW55O1xuICBwcml2YXRlIHZhbHVlQmVmb3JlQ2hhbmdlOiBhbnk7XG5cbiAgQFZpZXdDaGlsZCgnYm9keUVsZW1lbnQnLCB7IHN0YXRpYzogdHJ1ZSB9KSBib2R5RWxlbWVudDogRWxlbWVudFJlZjtcblxuICBASW5wdXQoJ3AtaGVpZ2h0JykgaGVpZ2h0Pzogc3RyaW5nO1xuXG4gIEBJbnB1dCgncC1tb2RlbC12YWx1ZScpIG1vZGVsVmFsdWU/OiBzdHJpbmc7XG5cbiAgQElucHV0KCdwLXBsYWNlaG9sZGVyJykgcGxhY2Vob2xkZXI/OiBzdHJpbmc7XG5cbiAgQElucHV0KCdwLXJlYWRvbmx5JykgcmVhZG9ubHk/OiBzdHJpbmc7XG5cbiAgQE91dHB1dCgncC1jaGFuZ2UnKSBjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdwLWNvbW1hbmRzJykgY29tbWFuZHMgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdwLXNlbGVjdGVkLWxpbmsnKSBzZWxlY3RlZExpbmsgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdwLXNob3J0Y3V0LWNvbW1hbmQnKSBzaG9ydGN1dENvbW1hbmQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdwLXZhbHVlJykgdmFsdWUgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQuZGVzaWduTW9kZSA9ICdvbic7XG5cbiAgICAvLyB0aW1lb3V0IG5lY2Vzc8OhcmlvIHBhcmEgc2V0YXIgbyB2YWxvciB2aW5kbyBkbyB3cml0ZVZhbHVlIGRvIGNvbXBvbmVudGUgcHJpbmNpcGFsLlxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy51cGRhdGVWYWx1ZVdpdGhNb2RlbFZhbHVlKCkpO1xuICB9XG5cbiAgZXhlY3V0ZUNvbW1hbmQoY29tbWFuZDogc3RyaW5nIHwgeyBjb21tYW5kOiBhbnk7IHZhbHVlOiBzdHJpbmcgfCBhbnkgfSkge1xuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuXG4gICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSAnb2JqZWN0Jykge1xuICAgICAgaWYgKGNvbW1hbmQuY29tbWFuZCA9PT0gJ0luc2VydEhUTUwnKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICBjb21tYW5kOiBsaW5rQ29tbWFuZCxcbiAgICAgICAgICB2YWx1ZTogeyB1cmxMaW5rIH0sXG4gICAgICAgICAgdmFsdWU6IHsgdXJsTGlua1RleHQgfVxuICAgICAgICB9ID0gY29tbWFuZDtcblxuICAgICAgICB0aGlzLmhhbmRsZUNvbW1hbmRMaW5rKGxpbmtDb21tYW5kLCB1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZChjb21tYW5kLmNvbW1hbmQsIGZhbHNlLCBjb21tYW5kLnZhbHVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoY29tbWFuZCwgZmFsc2UsIG51bGwpO1xuICAgIH1cblxuICAgIHRoaXMudXBkYXRlTW9kZWwoKTtcbiAgICB0aGlzLnZhbHVlLmVtaXQodGhpcy5tb2RlbFZhbHVlKTtcbiAgfVxuXG4gIGxpbmtFZGl0aW5nKGV2ZW50KSB7XG4gICAgdGhpcy5pc0xpbmtFZGl0aW5nID0gISFldmVudDtcbiAgfVxuXG4gIG9uQmx1cigpIHtcbiAgICBpZiAodGhpcy5tb2RlbFZhbHVlICE9PSB0aGlzLnZhbHVlQmVmb3JlQ2hhbmdlKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0Q2hhbmdlKTtcbiAgICAgIHRoaXMudGltZW91dENoYW5nZSA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KHRoaXMubW9kZWxWYWx1ZSk7XG4gICAgICB9LCAyMDApO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzKCk6IHZvaWQge1xuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICB9XG5cbiAgb25DbGljaygpIHtcbiAgICB0aGlzLmVtaXRTZWxlY3Rpb25Db21tYW5kcygpO1xuICB9XG5cbiAgb25Gb2N1cygpIHtcbiAgICB0aGlzLnZhbHVlQmVmb3JlQ2hhbmdlID0gdGhpcy5tb2RlbFZhbHVlO1xuICB9XG5cbiAgb25LZXlEb3duKGV2ZW50KSB7XG4gICAgY29uc3Qga2V5SyA9IGV2ZW50LmtleUNvZGUgPT09IFBvS2V5Q29kZUVudW0ua2V5SztcbiAgICBjb25zdCBpc0xpbmtTaG9ydGN1dCA9IChrZXlLICYmIGV2ZW50LmN0cmxLZXkpIHx8IChrZXlLICYmIGV2ZW50Lm1ldGFLZXkpO1xuXG4gICAgaWYgKGlzTGlua1Nob3J0Y3V0KSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdGhpcy5zaG9ydGN1dENvbW1hbmQuZW1pdCgpO1xuICAgIH1cblxuICAgIHRoaXMudG9nZ2xlQ3Vyc29yT25MaW5rKGV2ZW50LCAnYWRkJyk7XG4gIH1cblxuICBvbktleVVwKGV2ZW50OiBhbnkpIHtcbiAgICB0aGlzLnRvZ2dsZUN1cnNvck9uTGluayhldmVudCwgJ3JlbW92ZScpO1xuXG4gICAgdGhpcy5yZW1vdmVCckVsZW1lbnQoKTtcbiAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XG4gICAgdGhpcy5lbWl0U2VsZWN0aW9uQ29tbWFuZHMoKTtcbiAgfVxuXG4gIG9uUGFzdGUoKSB7XG4gICAgdGhpcy5hZGRDbGlja0xpc3RlbmVyT25BbmNob3JFbGVtZW50cygpO1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cblxuICB1cGRhdGUoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZU1vZGVsKCkpO1xuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnJlbW92ZUJyRWxlbWVudCgpO1xuICAgICAgdGhpcy51cGRhdGVNb2RlbCgpO1xuICAgICAgdGhpcy5lbWl0U2VsZWN0aW9uQ29tbWFuZHMoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQ2xpY2tMaXN0ZW5lck9uQW5jaG9yRWxlbWVudHMoKSB7XG4gICAgdGhpcy5ib2R5RWxlbWVudC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2EnKS5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25BbmNob3JDbGljayk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRTZWxlY3Rpb25Db21tYW5kcygpIHtcbiAgICBjb25zdCBjb21tYW5kcyA9IHBvUmljaFRleHRCb2R5Q29tbWFuZHMuZmlsdGVyKGNvbW1hbmQgPT4gZG9jdW1lbnQucXVlcnlDb21tYW5kU3RhdGUoY29tbWFuZCkpO1xuICAgIGNvbnN0IHJnYkNvbG9yID0gZG9jdW1lbnQucXVlcnlDb21tYW5kVmFsdWUoJ0ZvcmVDb2xvcicpO1xuXG4gICAgbGV0IGhleENvbG9yO1xuICAgIGlmICghaXNJRSgpKSB7XG4gICAgICBoZXhDb2xvciA9IHRoaXMucmdiVG9IZXgocmdiQ29sb3IpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzQ3Vyc29yUG9zaXRpb25lZEluQUxpbmsoKSkge1xuICAgICAgY29tbWFuZHMucHVzaCgnQ3JlYXRlbGluaycpO1xuICAgIH1cblxuICAgIHRoaXMuc2VsZWN0ZWRMaW5rLmVtaXQodGhpcy5saW5rRWxlbWVudCk7IC8vIGltcG9ydGFudGUgZmljYXIgZm9yYSBkbyBpZiBwYXJhIGVtaXRpciBtZXNtbyB1bmRlZmluZWQuXG4gICAgdGhpcy5jb21tYW5kcy5lbWl0KHsgY29tbWFuZHMsIGhleENvbG9yIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUZXh0U2VsZWN0aW9uKCkge1xuICAgIGNvbnN0IHRleHRTZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTtcbiAgICBpZiAoIXRleHRTZWxlY3Rpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZm9jdXNOb2RlID0gdGV4dFNlbGVjdGlvbi5mb2N1c05vZGUgPyB0ZXh0U2VsZWN0aW9uLmZvY3VzTm9kZS5wYXJlbnRFbGVtZW50IDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IGFuY2hvck5vZGUgPSB0ZXh0U2VsZWN0aW9uLmFuY2hvck5vZGUgPyB0ZXh0U2VsZWN0aW9uLmFuY2hvck5vZGUucGFyZW50Tm9kZSA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBub2RlID0gZm9jdXNOb2RlIHx8IGFuY2hvck5vZGU7XG4gICAgbGV0IHRhZ05hbWU7XG5cbiAgICBpZiAobm9kZSkge1xuICAgICAgdGFnTmFtZSA9IG5vZGVbJ3RhZ05hbWUnXSB8fCBub2RlWydub2RlTmFtZSddO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbm9kZSxcbiAgICAgICAgdGFnTmFtZVxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUNvbW1hbmRMaW5rKGxpbmtDb21tYW5kOiBzdHJpbmcsIHVybExpbms6IHN0cmluZywgdXJsTGlua1RleHQ6IHN0cmluZykge1xuICAgIGlmIChpc0lFKCkpIHtcbiAgICAgIHRoaXMuaW5zZXJ0SHRtbExpbmtFbGVtZW50KHVybExpbmssIHVybExpbmtUZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gJyZuYnNwOycgbmVjZXNzw6FyaW8gcGFyYSBvIGN1cnNvciBuw6NvIGZpY2FyIHByZXNvIGRlbnRybyBkbyBsaW5rIG5vIEZpcmVmb3guXG4gICAgICBjb25zdCBsaW5rVmFsdWUgPVxuICAgICAgICBpc0ZpcmVmb3goKSAmJiAhdGhpcy5pc0xpbmtFZGl0aW5nXG4gICAgICAgICAgPyBgJm5ic3A7JHt0aGlzLm1ha2VMaW5rVGFnKHVybExpbmssIHVybExpbmtUZXh0KX0mbmJzcDtgXG4gICAgICAgICAgOiB0aGlzLm1ha2VMaW5rVGFnKHVybExpbmssIHVybExpbmtUZXh0KTtcblxuICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQobGlua0NvbW1hbmQsIGZhbHNlLCBsaW5rVmFsdWUpO1xuICAgIH1cblxuICAgIHRoaXMuYWRkQ2xpY2tMaXN0ZW5lck9uQW5jaG9yRWxlbWVudHMoKTtcbiAgfVxuXG4gIC8vIHRyYXRhbWVudG8gZXNwZWPDrWZpY28gcGFyYSBJRSBwb2lzIG7Do28gc3Vwb3J0YSBvIGNvbWFuZG8gJ2luc2VydEhUTUwnLlxuICBwcml2YXRlIGluc2VydEh0bWxMaW5rRWxlbWVudCh1cmxMaW5rOiBzdHJpbmcsIHVybExpbmtUZXh0OiBzdHJpbmcpIHtcbiAgICBjb25zdCBzZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTtcbiAgICBjb25zdCBzZWxlY3Rpb25SYW5nZSA9IHNlbGVjdGlvbi5nZXRSYW5nZUF0KDApO1xuICAgIGNvbnN0IGVsZW1lbnRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuICAgIGNvbnN0IGVsZW1lbnRsaW5rVGV4dCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHVybExpbmtUZXh0KTtcblxuICAgIGVsZW1lbnRMaW5rLmFwcGVuZENoaWxkKGVsZW1lbnRsaW5rVGV4dCk7XG4gICAgZWxlbWVudExpbmsuaHJlZiA9IHVybExpbms7XG4gICAgZWxlbWVudExpbmsuc2V0QXR0cmlidXRlKCd0YXJnZXQnLCAnX2JsYW5rJyk7XG4gICAgZWxlbWVudExpbmsuY2xhc3NMaXN0LmFkZCgncG8tcmljaC10ZXh0LWxpbmsnKTtcblxuICAgIHNlbGVjdGlvblJhbmdlLmRlbGV0ZUNvbnRlbnRzKCk7XG4gICAgc2VsZWN0aW9uUmFuZ2UuaW5zZXJ0Tm9kZShlbGVtZW50TGluayk7XG4gIH1cblxuICBwcml2YXRlIGlzQ3Vyc29yUG9zaXRpb25lZEluQUxpbmsoKTogYm9vbGVhbiB7XG4gICAgY29uc3QgdGV4dFNlbGVjdGlvbiA9IHRoaXMuZ2V0VGV4dFNlbGVjdGlvbigpO1xuICAgIHRoaXMubGlua0VsZW1lbnQgPSB1bmRlZmluZWQ7XG5cbiAgICBsZXQgaXNMaW5rID0gZmFsc2U7XG5cbiAgICBpZiAodGV4dFNlbGVjdGlvbiAmJiB0ZXh0U2VsZWN0aW9uLm5vZGUgJiYgdGV4dFNlbGVjdGlvbi50YWdOYW1lID09PSAnQScpIHtcbiAgICAgIHRoaXMubGlua0VsZW1lbnQgPSB0ZXh0U2VsZWN0aW9uLm5vZGU7XG4gICAgICBpc0xpbmsgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoKGlzRmlyZWZveCgpIHx8IGlzSUVPckVkZ2UoKSkgJiYgdGhpcy52ZXJpZnlDdXJzb3JQb3NpdGlvbkluRmlyZWZveElFRWRnZSgpKSB7XG4gICAgICBpc0xpbmsgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpc0xpbmsgPSB0ZXh0U2VsZWN0aW9uID8gdGhpcy5pc1BhcmVudE5vZGVBbmNob3IodGV4dFNlbGVjdGlvbikgOiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIGlzTGluaztcbiAgfVxuXG4gIHByaXZhdGUgaXNQYXJlbnROb2RlQW5jaG9yKHRleHRTZWxlY3Rpb24pOiBib29sZWFuIHtcbiAgICBsZXQgZWxlbWVudCA9IHRleHRTZWxlY3Rpb24ubm9kZTtcbiAgICBsZXQgaXNMaW5rID0gZmFsc2U7XG5cbiAgICB3aGlsZSAoZWxlbWVudCAmJiAoZWxlbWVudC50YWdOYW1lICE9PSBudWxsIHx8IGVsZW1lbnQubm9kZU5hbWUgIT09IG51bGwpKSB7XG4gICAgICBpZiAoZWxlbWVudC50YWdOYW1lID09PSAnQScgfHwgZWxlbWVudC5ub2RlTmFtZSA9PT0gJ0EnKSB7XG4gICAgICAgIHRoaXMubGlua0VsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgICBpc0xpbmsgPSB0cnVlO1xuICAgICAgICByZXR1cm4gaXNMaW5rO1xuICAgICAgfVxuICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudCB8fCBlbGVtZW50LnBhcmVudE5vZGU7XG4gICAgfVxuXG4gICAgdGhpcy5saW5rRWxlbWVudCA9IHVuZGVmaW5lZDtcbiAgICByZXR1cm4gaXNMaW5rO1xuICB9XG5cbiAgcHJpdmF0ZSBtYWtlTGlua1RhZyh1cmxMaW5rOiBzdHJpbmcsIHVybExpbmtUZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYDxhIGNsYXNzPVwicG8tcmljaC10ZXh0LWxpbmtcIiBocmVmPVwiJHt1cmxMaW5rfVwiIHRhcmdldD1cIl9ibGFua1wiPiR7dXJsTGlua1RleHQgfHwgdXJsTGlua308L2E+YDtcbiAgfVxuXG4gIHByaXZhdGUgb25BbmNob3JDbGljayA9IGV2ZW50ID0+IHtcbiAgICBjb25zdCB7IHRhcmdldCwgY3RybEtleSwgbWV0YUtleSB9ID0gZXZlbnQ7XG4gICAgbGV0IHVybDtcbiAgICBsZXQgZWxlbWVudExpbms7XG5cbiAgICBpZiAoY3RybEtleSB8fCBtZXRhS2V5KSB7XG4gICAgICBpZiAoZXZlbnQucGF0aCkge1xuICAgICAgICBldmVudC5wYXRoLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAgICAgaWYgKGVsZW1lbnQubm9kZU5hbWUgPT09ICdBJykge1xuICAgICAgICAgICAgdXJsID0gZWxlbWVudC5ocmVmO1xuICAgICAgICAgICAgZWxlbWVudExpbmsgPSBlbGVtZW50O1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB1cmwgPSB0YXJnZXQuYXR0cmlidXRlcy5ocmVmLnZhbHVlO1xuICAgICAgICBlbGVtZW50TGluayA9IHRhcmdldDtcbiAgICAgIH1cbiAgICAgIG9wZW5FeHRlcm5hbExpbmsodXJsKTtcbiAgICAgIGVsZW1lbnRMaW5rLmNsYXNzTGlzdC5yZW1vdmUoJ3BvLWNsaWNrYWJsZScpO1xuICAgIH1cbiAgfTtcblxuICAvLyBUcmF0YW1lbnRvIG5lY2Vzc8OhcmlvIHBhcmEgZWxpbWluYXIgYSB0YWcgPGJyPiBjcmlhZGEgbm8gZmlyZWZveCBxdWFuZG8gbyBib2R5IGZvciBsaW1wby5cbiAgcHJpdmF0ZSByZW1vdmVCckVsZW1lbnQoKSB7XG4gICAgY29uc3QgYm9keUVsZW1lbnQgPSB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICBpZiAoIWJvZHlFbGVtZW50LmlubmVyVGV4dC50cmltKCkgJiYgYm9keUVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgYm9keUVsZW1lbnQucXVlcnlTZWxlY3RvcignYnInKSkge1xuICAgICAgYm9keUVsZW1lbnQucXVlcnlTZWxlY3RvcignYnInKS5yZW1vdmUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJnYlRvSGV4KHJnYikge1xuICAgIC8vIFRyYXRhbWVudG8gbmVjZXNzw6FyaW8gcGFyYSBjb252ZXJ0ZXIgbyBjw7NkaWdvIHJnYiBwYXJhIGhleGFkZWNpbWFsLlxuICAgIGNvbnN0IHNlcCA9IHJnYi5pbmRleE9mKCcsJykgPiAtMSA/ICcsJyA6ICcgJztcbiAgICByZ2IgPSByZ2Iuc3Vic3RyKDQpLnNwbGl0KCcpJylbMF0uc3BsaXQoc2VwKTtcblxuICAgIGxldCByID0gKCtyZ2JbMF0pLnRvU3RyaW5nKDE2KTtcbiAgICBsZXQgZyA9ICgrcmdiWzFdKS50b1N0cmluZygxNik7XG4gICAgbGV0IGIgPSAoK3JnYlsyXSkudG9TdHJpbmcoMTYpO1xuXG4gICAgaWYgKHIubGVuZ3RoID09PSAxKSB7XG4gICAgICByID0gJzAnICsgcjtcbiAgICB9XG4gICAgaWYgKGcubGVuZ3RoID09PSAxKSB7XG4gICAgICBnID0gJzAnICsgZztcbiAgICB9XG4gICAgaWYgKGIubGVuZ3RoID09PSAxKSB7XG4gICAgICBiID0gJzAnICsgYjtcbiAgICB9XG5cbiAgICByZXR1cm4gJyMnICsgciArIGcgKyBiO1xuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVDdXJzb3JPbkxpbmsoZXZlbnQ6IGFueSwgYWN0aW9uOiAnYWRkJyB8ICdyZW1vdmUnKSB7XG4gICAgY29uc3Qgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XG4gICAgY29uc3QgZWxlbWVudCA9IHNlbGVjdGlvbi5mb2N1c05vZGUgPyBzZWxlY3Rpb24uZm9jdXNOb2RlLnBhcmVudE5vZGUgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgaXNDdHJsID0gZXZlbnQua2V5ID09PSAnQ29udHJvbCc7XG4gICAgY29uc3QgaXNDb21tYW5kID0gZXZlbnQua2V5ID09PSAnTWV0YSc7XG4gICAgY29uc3QgaXNPbkN0cmxMaW5rID0gdGhpcy5pc0N1cnNvclBvc2l0aW9uZWRJbkFMaW5rKCkgJiYgKGlzQ3RybCB8fCBpc0NvbW1hbmQpO1xuXG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIGlmIChpc09uQ3RybExpbmspIHtcbiAgICAgICAgZWxlbWVudFsnY2xhc3NMaXN0J11bYWN0aW9uXSgncG8tY2xpY2thYmxlJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBpc0NsaWNrYWJsZSA9IGVsZW1lbnRbJ2NsYXNzTGlzdCddICYmIGVsZW1lbnRbJ2NsYXNzTGlzdCddLmNvbnRhaW5zKCdwby1jbGlja2FibGUnKTtcblxuICAgICAgICBpZiAoaXNDbGlja2FibGUpIHtcbiAgICAgICAgICBlbGVtZW50WydjbGFzc0xpc3QnXS5yZW1vdmUoJ3BvLWNsaWNrYWJsZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVNb2RlbCgpIHtcbiAgICB0aGlzLm1vZGVsVmFsdWUgPSB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MO1xuXG4gICAgdGhpcy52YWx1ZS5lbWl0KHRoaXMubW9kZWxWYWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVZhbHVlV2l0aE1vZGVsVmFsdWUoKSB7XG4gICAgaWYgKHRoaXMubW9kZWxWYWx1ZSkge1xuICAgICAgdGhpcy5ib2R5RWxlbWVudC5uYXRpdmVFbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgnYWZ0ZXJiZWdpbicsIHRoaXMubW9kZWxWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB2ZXJpZnlDdXJzb3JQb3NpdGlvbkluRmlyZWZveElFRWRnZSgpOiBib29sZWFuIHtcbiAgICBjb25zdCB0ZXh0U2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XG4gICAgY29uc3Qgbm9kZUxpbmsgPSB0ZXh0U2VsZWN0aW9uLmZvY3VzTm9kZTtcbiAgICBsZXQgaXNMaW5rID0gZmFsc2U7XG5cbiAgICBpZiAobm9kZUxpbmsgJiYgbm9kZUxpbmsubm9kZU5hbWUgPT09ICdBJykge1xuICAgICAgdGhpcy5saW5rRWxlbWVudCA9IG5vZGVMaW5rO1xuICAgICAgaXNMaW5rID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcmFuZ2UgPSB0ZXh0U2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7XG4gICAgICBjb25zdCBmcmFnbWVudERvY3VtZW50ID0gcmFuZ2UuY2xvbmVDb250ZW50cygpO1xuICAgICAgY29uc3QgZWxlbWVudCA9IGZyYWdtZW50RG9jdW1lbnQuY2hpbGROb2Rlc1swXSB8fCBmcmFnbWVudERvY3VtZW50LmZpcnN0RWxlbWVudENoaWxkO1xuXG4gICAgICB0aGlzLmxpbmtFbGVtZW50ID0gZWxlbWVudCAmJiBlbGVtZW50Lm5vZGVOYW1lID09PSAnQScgPyBlbGVtZW50IDogdW5kZWZpbmVkO1xuICAgICAgaXNMaW5rID0gISF0aGlzLmxpbmtFbGVtZW50O1xuICAgIH1cblxuICAgIHJldHVybiBpc0xpbms7XG4gIH1cbn1cbiJdfQ==