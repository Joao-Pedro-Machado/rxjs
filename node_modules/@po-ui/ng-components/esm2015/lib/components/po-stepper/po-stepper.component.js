import { ChangeDetectorRef, Component, ContentChildren, QueryList } from '@angular/core';
import { Observable, of, throwError } from 'rxjs';
import { take, tap, catchError } from 'rxjs/operators';
import { PoStepperStatus } from './enums/po-stepper-status.enum';
import { PoStepComponent } from './po-step/po-step.component';
import { PoStepperBaseComponent } from './po-stepper-base.component';
/**
 * @docsExtends PoStepperBaseComponent
 *
 * @example
 *
 * <example name="po-stepper-basic" title="PO Stepper Basic">
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.html"> </file>
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-labs" title="PO Stepper Labs">
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.html"> </file>
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-sales" title="PO Stepper - Sales">
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.html"> </file>
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.ts"> </file>
 * </example>
 */
export class PoStepperComponent extends PoStepperBaseComponent {
    constructor(changeDetector) {
        super();
        this.changeDetector = changeDetector;
    }
    get currentStepIndex() {
        return this.step - 1;
    }
    get stepList() {
        return (this.usePoSteps && this.poSteps) || this.steps;
    }
    get usePoSteps() {
        return !!this.poSteps.length;
    }
    ngAfterContentInit() {
        this.activeFirstStep();
        this.poSteps.changes.subscribe(() => {
            this.controlStepsStatus(0, this.poSteps.first);
        });
    }
    /**
     * Altera o status do *step* para ativo.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     *
     * @param {number} index Índice do `po-step` que se deseja ativar.
     */
    active(index) {
        if (!this.usePoSteps) {
            return;
        }
        const stepsArray = this.getPoSteps();
        const step = stepsArray[index];
        const isDisabledStep = step.status === PoStepperStatus.Disabled;
        const isErrorStep = step.status === PoStepperStatus.Error;
        if (!isDisabledStep || isErrorStep) {
            this.changeStep(index, step);
        }
    }
    /**
     * Ativa o primeiro *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    first() {
        if (!this.usePoSteps) {
            return;
        }
        const firstStep = this.poSteps.first;
        const firstStepIndex = 0;
        this.changeStep(firstStepIndex, firstStep);
    }
    /**
     * Ativa o próximo *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    next() {
        if (!this.usePoSteps) {
            return;
        }
        const { steps, stepIndex } = this.getStepsAndIndex(this.currentActiveStep);
        const nextIndex = stepIndex + 1;
        const nextStep = steps[nextIndex];
        this.changeStep(nextIndex, nextStep);
    }
    /**
     * Ativa o *step* anterior.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    previous() {
        if (!this.usePoSteps) {
            return;
        }
        const { steps, stepIndex } = this.getStepsAndIndex(this.currentActiveStep);
        const previousIndex = stepIndex - 1;
        const previousStep = steps[previousIndex];
        this.changeStep(previousIndex, previousStep);
    }
    changeStep(stepIndex, step) {
        this.allowNextStep(stepIndex)
            .pipe(take(1))
            .subscribe(nextStepAllowed => {
            if (nextStepAllowed) {
                const isDifferentStep = !this.currentActiveStep || step.id !== this.currentActiveStep.id;
                if (this.usePoSteps && isDifferentStep) {
                    this.controlStepsStatus(stepIndex, step);
                    this.onChangeStep.emit(step);
                }
                else if (!this.usePoSteps && stepIndex !== this.currentStepIndex) {
                    // if para tratamento do modelo antigo do po-stepper
                    this.onChangeStep.emit(stepIndex + 1);
                }
            }
        });
    }
    onStepActive(step) {
        this.currentActiveStep = step;
        this.previousActiveStep = this.poSteps.find(stepChild => stepChild.status === PoStepperStatus.Active && stepChild.id !== step.id);
        this.setPreviousStepAsDone();
    }
    trackByFn(step) {
        return step.id;
    }
    activeFirstStep() {
        const hasStepActive = this.poSteps.some(poStep => poStep.status === PoStepperStatus.Active);
        if (this.usePoSteps && !hasStepActive) {
            this.changeStep(0, this.poSteps.first);
        }
    }
    allowNextStep(nextStepIndex) {
        if (!this.sequential) {
            return of(true);
        }
        const isAllowNextStep$ = this.usePoSteps
            ? this.isBeforeStep(nextStepIndex) || this.canActiveNextStep(this.currentActiveStep)
            : this.steps.slice(this.step, nextStepIndex).every(step => step.status === PoStepperStatus.Done);
        return typeof isAllowNextStep$ === 'boolean' ? of(isAllowNextStep$) : isAllowNextStep$;
    }
    canActiveNextStep(currentActiveStep = {}) {
        if (!currentActiveStep.canActiveNextStep) {
            return of(true);
        }
        const canActiveNextStep = currentActiveStep.canActiveNextStep(currentActiveStep);
        const canActiveNextStep$ = canActiveNextStep instanceof Observable ? canActiveNextStep : of(canActiveNextStep);
        return canActiveNextStep$.pipe(tap(isCanActiveNextStep => {
            currentActiveStep.status = this.getStepperStatusByCanActive(isCanActiveNextStep);
        }), catchError(err => {
            currentActiveStep.status = PoStepperStatus.Error;
            return throwError(err);
        }));
    }
    controlStepsStatus(stepIndex, step) {
        if (this.usePoSteps) {
            this.setStepAsActive(step);
            this.setNextStepAsDefault(step);
            if (this.isBeforeStep(stepIndex)) {
                this.setFinalSteppersAsDisabled(stepIndex);
            }
            this.changeDetector.detectChanges();
        }
    }
    getStepperStatusByCanActive(canActiveNextStep) {
        return canActiveNextStep ? PoStepperStatus.Done : PoStepperStatus.Error;
    }
    getStepsAndIndex(step = {}) {
        const steps = this.getPoSteps();
        const stepIndex = steps.findIndex(poStep => poStep.id === step.id);
        return { steps, stepIndex };
    }
    getPoSteps() {
        return this.poSteps.toArray();
    }
    isBeforeStep(stepIndex) {
        const currentActiveStepIndex = () => this.getPoSteps().findIndex(step => step.id === this.currentActiveStep.id);
        return !!this.currentActiveStep && currentActiveStepIndex() >= stepIndex;
    }
    setFinalSteppersAsDisabled(stepIndex) {
        this.getPoSteps()
            .filter((step, index) => step && index >= stepIndex + 2)
            .forEach(step => (step.status = PoStepperStatus.Disabled));
    }
    setStepAsActive(step) {
        step.status = PoStepperStatus.Active;
    }
    setNextStepAsDefault(currentStep) {
        const { steps, stepIndex } = this.getStepsAndIndex(currentStep);
        const nextIndex = stepIndex + 1;
        if (nextIndex < this.poSteps.length) {
            steps[nextIndex].status = PoStepperStatus.Default;
        }
    }
    setPreviousStepAsDone() {
        if (this.previousActiveStep) {
            this.previousActiveStep.status = PoStepperStatus.Done;
        }
    }
}
PoStepperComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-stepper',
                template: "<div class=\"po-stepper po-stepper-{{ orientation }}\">\n  <div class=\"po-stepper-container\">\n    <po-stepper-step\n      *ngFor=\"let step of stepList; let index = index; trackBy: trackByFn\"\n      class=\"po-stepper-step-position\"\n      [p-circle-content]=\"index + 1\"\n      [p-label]=\"step.label\"\n      [p-orientation]=\"orientation\"\n      [p-status]=\"step.status\"\n      [p-step-icons]=\"stepIcons\"\n      [p-step-size]=\"stepSize\"\n      (p-activated)=\"onStepActive(step)\"\n      (p-click)=\"changeStep(index, step)\"\n      (p-enter)=\"changeStep(index, step)\"\n    >\n    </po-stepper-step>\n  </div>\n\n  <div *ngIf=\"usePoSteps\" class=\"po-stepper-content\">\n    <ng-content></ng-content>\n  </div>\n</div>\n"
            },] }
];
PoStepperComponent.ctorParameters = () => [
    { type: ChangeDetectorRef }
];
PoStepperComponent.propDecorators = {
    poSteps: [{ type: ContentChildren, args: [PoStepComponent,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tc3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tc3RlcHBlci9wby1zdGVwcGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW9CLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNHLE9BQU8sRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV2RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDakUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzlELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBR3JFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBbUJHO0FBS0gsTUFBTSxPQUFPLGtCQUFtQixTQUFRLHNCQUFzQjtJQWtCNUQsWUFBb0IsY0FBaUM7UUFDbkQsS0FBSyxFQUFFLENBQUM7UUFEVSxtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7SUFFckQsQ0FBQztJQWRELElBQUksZ0JBQWdCO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVELElBQUksUUFBUTtRQUNWLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3pELENBQUM7SUFFRCxJQUFJLFVBQVU7UUFDWixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUMvQixD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QUFDO2dCQUNULFFBQVEsRUFBRSxZQUFZO2dCQUN0QiwrdUJBQTBDO2FBQzNDOzs7WUFqQzBCLGlCQUFpQjs7O3NCQW1DekMsZUFBZSxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlckNvbnRlbnRJbml0LCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBDb250ZW50Q2hpbGRyZW4sIFF1ZXJ5TGlzdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZSwgdGFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBQb1N0ZXBwZXJTdGF0dXMgfSBmcm9tICcuL2VudW1zL3BvLXN0ZXBwZXItc3RhdHVzLmVudW0nO1xuaW1wb3J0IHsgUG9TdGVwQ29tcG9uZW50IH0gZnJvbSAnLi9wby1zdGVwL3BvLXN0ZXAuY29tcG9uZW50JztcbmltcG9ydCB7IFBvU3RlcHBlckJhc2VDb21wb25lbnQgfSBmcm9tICcuL3BvLXN0ZXBwZXItYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9TdGVwcGVySXRlbSB9IGZyb20gJy4vcG8tc3RlcHBlci1pdGVtLmludGVyZmFjZSc7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFBvU3RlcHBlckJhc2VDb21wb25lbnRcbiAqXG4gKiBAZXhhbXBsZVxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zdGVwcGVyLWJhc2ljXCIgdGl0bGU9XCJQTyBTdGVwcGVyIEJhc2ljXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zdGVwcGVyLWJhc2ljL3NhbXBsZS1wby1zdGVwcGVyLWJhc2ljLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMvc2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tc3RlcHBlci1sYWJzXCIgdGl0bGU9XCJQTyBTdGVwcGVyIExhYnNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItbGFicy9zYW1wbGUtcG8tc3RlcHBlci1sYWJzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItbGFicy9zYW1wbGUtcG8tc3RlcHBlci1sYWJzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLXN0ZXBwZXItc2FsZXNcIiB0aXRsZT1cIlBPIFN0ZXBwZXIgLSBTYWxlc1wiPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc3RlcHBlci1zYWxlcy9zYW1wbGUtcG8tc3RlcHBlci1zYWxlcy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zdGVwcGVyLXNhbGVzL3NhbXBsZS1wby1zdGVwcGVyLXNhbGVzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLXN0ZXBwZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tc3RlcHBlci5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUG9TdGVwcGVyQ29tcG9uZW50IGV4dGVuZHMgUG9TdGVwcGVyQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyQ29udGVudEluaXQge1xuICBAQ29udGVudENoaWxkcmVuKFBvU3RlcENvbXBvbmVudCkgcG9TdGVwczogUXVlcnlMaXN0PFBvU3RlcENvbXBvbmVudD47XG5cbiAgcHJpdmF0ZSBjdXJyZW50QWN0aXZlU3RlcDogUG9TdGVwQ29tcG9uZW50O1xuICBwcml2YXRlIHByZXZpb3VzQWN0aXZlU3RlcDogUG9TdGVwQ29tcG9uZW50O1xuXG4gIGdldCBjdXJyZW50U3RlcEluZGV4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuc3RlcCAtIDE7XG4gIH1cblxuICBnZXQgc3RlcExpc3QoKTogUXVlcnlMaXN0PFBvU3RlcENvbXBvbmVudD4gfCBBcnJheTxQb1N0ZXBwZXJJdGVtPiB7XG4gICAgcmV0dXJuICh0aGlzLnVzZVBvU3RlcHMgJiYgdGhpcy5wb1N0ZXBzKSB8fCB0aGlzLnN0ZXBzO1xuICB9XG5cbiAgZ2V0IHVzZVBvU3RlcHMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5wb1N0ZXBzLmxlbmd0aDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICB0aGlzLmFjdGl2ZUZpcnN0U3RlcCgpO1xuXG4gICAgdGhpcy5wb1N0ZXBzLmNoYW5nZXMuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuY29udHJvbFN0ZXBzU3RhdHVzKDAsIHRoaXMucG9TdGVwcy5maXJzdCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWx0ZXJhIG8gc3RhdHVzIGRvICpzdGVwKiBwYXJhIGF0aXZvLlxuICAgKlxuICAgKiA+IEVzdGUgbcOpdG9kbyDDqSB2YWxpZG8gYXBlbmFzIHBhcmEgYXMgaW1wbGVtZW50YcOnw7VlcyBxdWUgdXRpbGl6YW0gbyBjb21wb25lbnRlIFsqKnBvLXN0ZXAqKl0oL2RvY3VtZW50YXRpb24vcG8tc3RlcCkuXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCDDjW5kaWNlIGRvIGBwby1zdGVwYCBxdWUgc2UgZGVzZWphIGF0aXZhci5cbiAgICovXG4gIGFjdGl2ZShpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnVzZVBvU3RlcHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzdGVwc0FycmF5ID0gdGhpcy5nZXRQb1N0ZXBzKCk7XG4gICAgY29uc3Qgc3RlcCA9IHN0ZXBzQXJyYXlbaW5kZXhdO1xuICAgIGNvbnN0IGlzRGlzYWJsZWRTdGVwID0gc3RlcC5zdGF0dXMgPT09IFBvU3RlcHBlclN0YXR1cy5EaXNhYmxlZDtcbiAgICBjb25zdCBpc0Vycm9yU3RlcCA9IHN0ZXAuc3RhdHVzID09PSBQb1N0ZXBwZXJTdGF0dXMuRXJyb3I7XG5cbiAgICBpZiAoIWlzRGlzYWJsZWRTdGVwIHx8IGlzRXJyb3JTdGVwKSB7XG4gICAgICB0aGlzLmNoYW5nZVN0ZXAoaW5kZXgsIHN0ZXApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBdGl2YSBvIHByaW1laXJvICpzdGVwKi5cbiAgICpcbiAgICogPiBFc3RlIG3DqXRvZG8gw6kgdmFsaWRvIGFwZW5hcyBwYXJhIGFzIGltcGxlbWVudGHDp8O1ZXMgcXVlIHV0aWxpemFtIG8gY29tcG9uZW50ZSBbKipwby1zdGVwKipdKC9kb2N1bWVudGF0aW9uL3BvLXN0ZXApLlxuICAgKi9cbiAgZmlyc3QoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnVzZVBvU3RlcHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBmaXJzdFN0ZXAgPSB0aGlzLnBvU3RlcHMuZmlyc3Q7XG4gICAgY29uc3QgZmlyc3RTdGVwSW5kZXggPSAwO1xuXG4gICAgdGhpcy5jaGFuZ2VTdGVwKGZpcnN0U3RlcEluZGV4LCBmaXJzdFN0ZXApO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0aXZhIG8gcHLDs3hpbW8gKnN0ZXAqLlxuICAgKlxuICAgKiA+IEVzdGUgbcOpdG9kbyDDqSB2YWxpZG8gYXBlbmFzIHBhcmEgYXMgaW1wbGVtZW50YcOnw7VlcyBxdWUgdXRpbGl6YW0gbyBjb21wb25lbnRlIFsqKnBvLXN0ZXAqKl0oL2RvY3VtZW50YXRpb24vcG8tc3RlcCkuXG4gICAqL1xuICBuZXh0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy51c2VQb1N0ZXBzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBzdGVwcywgc3RlcEluZGV4IH0gPSB0aGlzLmdldFN0ZXBzQW5kSW5kZXgodGhpcy5jdXJyZW50QWN0aXZlU3RlcCk7XG4gICAgY29uc3QgbmV4dEluZGV4ID0gc3RlcEluZGV4ICsgMTtcbiAgICBjb25zdCBuZXh0U3RlcCA9IHN0ZXBzW25leHRJbmRleF07XG5cbiAgICB0aGlzLmNoYW5nZVN0ZXAobmV4dEluZGV4LCBuZXh0U3RlcCk7XG4gIH1cblxuICAvKipcbiAgICogQXRpdmEgbyAqc3RlcCogYW50ZXJpb3IuXG4gICAqXG4gICAqID4gRXN0ZSBtw6l0b2RvIMOpIHZhbGlkbyBhcGVuYXMgcGFyYSBhcyBpbXBsZW1lbnRhw6fDtWVzIHF1ZSB1dGlsaXphbSBvIGNvbXBvbmVudGUgWyoqcG8tc3RlcCoqXSgvZG9jdW1lbnRhdGlvbi9wby1zdGVwKS5cbiAgICovXG4gIHByZXZpb3VzKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy51c2VQb1N0ZXBzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBzdGVwcywgc3RlcEluZGV4IH0gPSB0aGlzLmdldFN0ZXBzQW5kSW5kZXgodGhpcy5jdXJyZW50QWN0aXZlU3RlcCk7XG4gICAgY29uc3QgcHJldmlvdXNJbmRleCA9IHN0ZXBJbmRleCAtIDE7XG4gICAgY29uc3QgcHJldmlvdXNTdGVwID0gc3RlcHNbcHJldmlvdXNJbmRleF07XG5cbiAgICB0aGlzLmNoYW5nZVN0ZXAocHJldmlvdXNJbmRleCwgcHJldmlvdXNTdGVwKTtcbiAgfVxuXG4gIGNoYW5nZVN0ZXAoc3RlcEluZGV4OiBudW1iZXIsIHN0ZXA/OiBQb1N0ZXBDb21wb25lbnQpOiB2b2lkIHtcbiAgICB0aGlzLmFsbG93TmV4dFN0ZXAoc3RlcEluZGV4KVxuICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgIC5zdWJzY3JpYmUobmV4dFN0ZXBBbGxvd2VkID0+IHtcbiAgICAgICAgaWYgKG5leHRTdGVwQWxsb3dlZCkge1xuICAgICAgICAgIGNvbnN0IGlzRGlmZmVyZW50U3RlcCA9ICF0aGlzLmN1cnJlbnRBY3RpdmVTdGVwIHx8IHN0ZXAuaWQgIT09IHRoaXMuY3VycmVudEFjdGl2ZVN0ZXAuaWQ7XG5cbiAgICAgICAgICBpZiAodGhpcy51c2VQb1N0ZXBzICYmIGlzRGlmZmVyZW50U3RlcCkge1xuICAgICAgICAgICAgdGhpcy5jb250cm9sU3RlcHNTdGF0dXMoc3RlcEluZGV4LCBzdGVwKTtcbiAgICAgICAgICAgIHRoaXMub25DaGFuZ2VTdGVwLmVtaXQoc3RlcCk7XG4gICAgICAgICAgfSBlbHNlIGlmICghdGhpcy51c2VQb1N0ZXBzICYmIHN0ZXBJbmRleCAhPT0gdGhpcy5jdXJyZW50U3RlcEluZGV4KSB7XG4gICAgICAgICAgICAvLyBpZiBwYXJhIHRyYXRhbWVudG8gZG8gbW9kZWxvIGFudGlnbyBkbyBwby1zdGVwcGVyXG4gICAgICAgICAgICB0aGlzLm9uQ2hhbmdlU3RlcC5lbWl0KHN0ZXBJbmRleCArIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBvblN0ZXBBY3RpdmUoc3RlcDogUG9TdGVwQ29tcG9uZW50KSB7XG4gICAgdGhpcy5jdXJyZW50QWN0aXZlU3RlcCA9IHN0ZXA7XG5cbiAgICB0aGlzLnByZXZpb3VzQWN0aXZlU3RlcCA9IHRoaXMucG9TdGVwcy5maW5kKFxuICAgICAgc3RlcENoaWxkID0+IHN0ZXBDaGlsZC5zdGF0dXMgPT09IFBvU3RlcHBlclN0YXR1cy5BY3RpdmUgJiYgc3RlcENoaWxkLmlkICE9PSBzdGVwLmlkXG4gICAgKTtcblxuICAgIHRoaXMuc2V0UHJldmlvdXNTdGVwQXNEb25lKCk7XG4gIH1cblxuICB0cmFja0J5Rm4oc3RlcDogUG9TdGVwQ29tcG9uZW50KSB7XG4gICAgcmV0dXJuIHN0ZXAuaWQ7XG4gIH1cblxuICBwcml2YXRlIGFjdGl2ZUZpcnN0U3RlcCgpIHtcbiAgICBjb25zdCBoYXNTdGVwQWN0aXZlID0gdGhpcy5wb1N0ZXBzLnNvbWUocG9TdGVwID0+IHBvU3RlcC5zdGF0dXMgPT09IFBvU3RlcHBlclN0YXR1cy5BY3RpdmUpO1xuXG4gICAgaWYgKHRoaXMudXNlUG9TdGVwcyAmJiAhaGFzU3RlcEFjdGl2ZSkge1xuICAgICAgdGhpcy5jaGFuZ2VTdGVwKDAsIHRoaXMucG9TdGVwcy5maXJzdCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhbGxvd05leHRTdGVwKG5leHRTdGVwSW5kZXg6IG51bWJlcik6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGlmICghdGhpcy5zZXF1ZW50aWFsKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuXG4gICAgY29uc3QgaXNBbGxvd05leHRTdGVwJCA9IHRoaXMudXNlUG9TdGVwc1xuICAgICAgPyB0aGlzLmlzQmVmb3JlU3RlcChuZXh0U3RlcEluZGV4KSB8fCB0aGlzLmNhbkFjdGl2ZU5leHRTdGVwKHRoaXMuY3VycmVudEFjdGl2ZVN0ZXApXG4gICAgICA6IHRoaXMuc3RlcHMuc2xpY2UodGhpcy5zdGVwLCBuZXh0U3RlcEluZGV4KS5ldmVyeShzdGVwID0+IHN0ZXAuc3RhdHVzID09PSBQb1N0ZXBwZXJTdGF0dXMuRG9uZSk7XG5cbiAgICByZXR1cm4gdHlwZW9mIGlzQWxsb3dOZXh0U3RlcCQgPT09ICdib29sZWFuJyA/IG9mKGlzQWxsb3dOZXh0U3RlcCQpIDogaXNBbGxvd05leHRTdGVwJDtcbiAgfVxuXG4gIHByaXZhdGUgY2FuQWN0aXZlTmV4dFN0ZXAoY3VycmVudEFjdGl2ZVN0ZXAgPSA8UG9TdGVwQ29tcG9uZW50Pnt9KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgaWYgKCFjdXJyZW50QWN0aXZlU3RlcC5jYW5BY3RpdmVOZXh0U3RlcCkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGNhbkFjdGl2ZU5leHRTdGVwID0gY3VycmVudEFjdGl2ZVN0ZXAuY2FuQWN0aXZlTmV4dFN0ZXAoY3VycmVudEFjdGl2ZVN0ZXApO1xuXG4gICAgY29uc3QgY2FuQWN0aXZlTmV4dFN0ZXAkID0gY2FuQWN0aXZlTmV4dFN0ZXAgaW5zdGFuY2VvZiBPYnNlcnZhYmxlID8gY2FuQWN0aXZlTmV4dFN0ZXAgOiBvZihjYW5BY3RpdmVOZXh0U3RlcCk7XG5cbiAgICByZXR1cm4gY2FuQWN0aXZlTmV4dFN0ZXAkLnBpcGUoXG4gICAgICB0YXAoaXNDYW5BY3RpdmVOZXh0U3RlcCA9PiB7XG4gICAgICAgIGN1cnJlbnRBY3RpdmVTdGVwLnN0YXR1cyA9IHRoaXMuZ2V0U3RlcHBlclN0YXR1c0J5Q2FuQWN0aXZlKGlzQ2FuQWN0aXZlTmV4dFN0ZXApO1xuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgIGN1cnJlbnRBY3RpdmVTdGVwLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5FcnJvcjtcblxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnIpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjb250cm9sU3RlcHNTdGF0dXMoc3RlcEluZGV4OiBudW1iZXIsIHN0ZXA6IFBvU3RlcENvbXBvbmVudCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnVzZVBvU3RlcHMpIHtcbiAgICAgIHRoaXMuc2V0U3RlcEFzQWN0aXZlKHN0ZXApO1xuICAgICAgdGhpcy5zZXROZXh0U3RlcEFzRGVmYXVsdChzdGVwKTtcblxuICAgICAgaWYgKHRoaXMuaXNCZWZvcmVTdGVwKHN0ZXBJbmRleCkpIHtcbiAgICAgICAgdGhpcy5zZXRGaW5hbFN0ZXBwZXJzQXNEaXNhYmxlZChzdGVwSW5kZXgpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFN0ZXBwZXJTdGF0dXNCeUNhbkFjdGl2ZShjYW5BY3RpdmVOZXh0U3RlcDogYm9vbGVhbik6IFBvU3RlcHBlclN0YXR1cyB7XG4gICAgcmV0dXJuIGNhbkFjdGl2ZU5leHRTdGVwID8gUG9TdGVwcGVyU3RhdHVzLkRvbmUgOiBQb1N0ZXBwZXJTdGF0dXMuRXJyb3I7XG4gIH1cblxuICBwcml2YXRlIGdldFN0ZXBzQW5kSW5kZXgoc3RlcDogUG9TdGVwQ29tcG9uZW50ID0gPGFueT57fSk6IHsgc3RlcHM6IEFycmF5PFBvU3RlcENvbXBvbmVudD47IHN0ZXBJbmRleDogbnVtYmVyIH0ge1xuICAgIGNvbnN0IHN0ZXBzID0gdGhpcy5nZXRQb1N0ZXBzKCk7XG4gICAgY29uc3Qgc3RlcEluZGV4ID0gc3RlcHMuZmluZEluZGV4KHBvU3RlcCA9PiBwb1N0ZXAuaWQgPT09IHN0ZXAuaWQpO1xuXG4gICAgcmV0dXJuIHsgc3RlcHMsIHN0ZXBJbmRleCB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQb1N0ZXBzKCk6IEFycmF5PFBvU3RlcENvbXBvbmVudD4ge1xuICAgIHJldHVybiB0aGlzLnBvU3RlcHMudG9BcnJheSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0JlZm9yZVN0ZXAoc3RlcEluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBjb25zdCBjdXJyZW50QWN0aXZlU3RlcEluZGV4ID0gKCkgPT4gdGhpcy5nZXRQb1N0ZXBzKCkuZmluZEluZGV4KHN0ZXAgPT4gc3RlcC5pZCA9PT0gdGhpcy5jdXJyZW50QWN0aXZlU3RlcC5pZCk7XG5cbiAgICByZXR1cm4gISF0aGlzLmN1cnJlbnRBY3RpdmVTdGVwICYmIGN1cnJlbnRBY3RpdmVTdGVwSW5kZXgoKSA+PSBzdGVwSW5kZXg7XG4gIH1cblxuICBwcml2YXRlIHNldEZpbmFsU3RlcHBlcnNBc0Rpc2FibGVkKHN0ZXBJbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5nZXRQb1N0ZXBzKClcbiAgICAgIC5maWx0ZXIoKHN0ZXAsIGluZGV4KSA9PiBzdGVwICYmIGluZGV4ID49IHN0ZXBJbmRleCArIDIpXG4gICAgICAuZm9yRWFjaChzdGVwID0+IChzdGVwLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5EaXNhYmxlZCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRTdGVwQXNBY3RpdmUoc3RlcDogUG9TdGVwQ29tcG9uZW50KTogdm9pZCB7XG4gICAgc3RlcC5zdGF0dXMgPSBQb1N0ZXBwZXJTdGF0dXMuQWN0aXZlO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXROZXh0U3RlcEFzRGVmYXVsdChjdXJyZW50U3RlcDogUG9TdGVwQ29tcG9uZW50KTogdm9pZCB7XG4gICAgY29uc3QgeyBzdGVwcywgc3RlcEluZGV4IH0gPSB0aGlzLmdldFN0ZXBzQW5kSW5kZXgoY3VycmVudFN0ZXApO1xuICAgIGNvbnN0IG5leHRJbmRleCA9IHN0ZXBJbmRleCArIDE7XG5cbiAgICBpZiAobmV4dEluZGV4IDwgdGhpcy5wb1N0ZXBzLmxlbmd0aCkge1xuICAgICAgc3RlcHNbbmV4dEluZGV4XS5zdGF0dXMgPSBQb1N0ZXBwZXJTdGF0dXMuRGVmYXVsdDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldFByZXZpb3VzU3RlcEFzRG9uZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wcmV2aW91c0FjdGl2ZVN0ZXApIHtcbiAgICAgIHRoaXMucHJldmlvdXNBY3RpdmVTdGVwLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5Eb25lO1xuICAgIH1cbiAgfVxufVxuIl19