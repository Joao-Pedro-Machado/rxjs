import { Component, ContentChild, ElementRef, HostListener, QueryList, ViewChild, ViewChildren } from '@angular/core';
import { animate, AnimationBuilder, keyframes, style } from '@angular/animations';
import { PoSlideBaseComponent } from './po-slide-base.component';
import { PoSlideContentTemplateDirective } from './directives/po-slide-content-template.directive';
import { PoSlideItemComponent } from './po-slide-item/po-slide-item.component';
const poSlideDefaultHeight = 336;
const poSlideIntervalMin = 1000;
const poSlideMinHeight = 192;
const poSlideTiming = '250ms ease';
/**
 * @docsExtends PoSlideBaseComponent
 *
 * @example
 * <example name="po-slide-basic" title="PO Slide Basic">
 *   <file name="sample-po-slide-basic/sample-po-slide-basic.component.html"> </file>
 *   <file name="sample-po-slide-basic/sample-po-slide-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-slide-labs" title="PO Slide Labs">
 *   <file name="sample-po-slide-labs/sample-po-slide-labs.component.html"> </file>
 *   <file name="sample-po-slide-labs/sample-po-slide-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-slide-useful-articles" title="PO Slide - Useful articles">
 *   <file name="sample-po-slide-useful-articles/sample-po-slide-useful-articles.component.html"> </file>
 *   <file name="sample-po-slide-useful-articles/sample-po-slide-useful-articles.component.ts"> </file>
 * </example>
 *
 * <example name="po-slide-landscapes" title="PO Slide - Landscapes">
 *   <file name="sample-po-slide-landscapes/sample-po-slide-landscapes.component.html"> </file>
 *   <file name="sample-po-slide-landscapes/sample-po-slide-landscapes.component.ts"> </file>
 * </example>
 */
export class PoSlideComponent extends PoSlideBaseComponent {
    constructor(builder) {
        super();
        this.builder = builder;
        this.isLoaded = false;
        this.currentSlideIndex = 0;
        this.slideItems = [];
    }
    get hasElements() {
        return !!this.slide.nativeElement.offsetWidth && !!this.itemsElements && !!this.itemsElements.length;
    }
    get isImageSlide() {
        return !this.slideContentTemplate;
    }
    get offset() {
        return this.currentSlideIndex * this.slideItemWidth;
    }
    get hasSlides() {
        return !!this.slides && !!this.slides.length;
    }
    onResize() {
        if (this.slide) {
            this.setSlideItemWidth();
            this.goToItem(this.currentSlideIndex);
        }
    }
    ngDoCheck() {
        if (!this.isLoaded && this.hasElements) {
            this.setSlideItemWidth();
            this.isLoaded = true;
            if (this.hasSlides) {
                this.startSlide();
            }
        }
    }
    ngOnChanges(changes) {
        if (changes.height) {
            this.setSlideHeight(this.height);
        }
    }
    goToItem(index) {
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.currentSlideIndex = index;
        this.animate(this.offset);
    }
    nextControl() {
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.next();
    }
    next() {
        if (this.currentSlideIndex + 1 === this.slideItems.length) {
            this.currentSlideIndex = 0;
            this.animate(0);
            return;
        }
        this.currentSlideIndex = (this.currentSlideIndex + 1) % this.slideItems.length;
        this.animate(this.offset);
    }
    previous() {
        if (this.currentSlideIndex === 0) {
            this.currentSlideIndex = this.slideItems.length - 1;
            this.animate(this.offset);
            return;
        }
        this.currentSlideIndex = (this.currentSlideIndex - 1 + this.slideItems.length) % this.slideItems.length;
        this.animate(this.offset);
    }
    previousControl() {
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.previous();
    }
    setSlideHeight(height) {
        this.setHeight(height);
    }
    animate(offset) {
        if (this.hasElements) {
            const animation = this.buildTransitionAnimation(offset);
            this.player = animation.create(this.slide.nativeElement);
            this.player.play();
        }
    }
    buildTransitionAnimation(offset) {
        return this.builder.build([animate(poSlideTiming, keyframes([style({ transform: `translateX(-${offset}px)` })]))]);
    }
    createArrayForTemplate(slides) {
        this.slideItems = [...slides];
    }
    createArrayFromSlides(slides) {
        const isStringArray = slides.every(item => typeof item === 'string');
        if (isStringArray) {
            slides.forEach(element => this.slideItems.push({ image: `${element}` }));
        }
        else {
            this.slideItems = [...slides];
        }
    }
    setDefaultHeight(height) {
        if ((height && height <= poSlideMinHeight) || (!height && this.isImageSlide)) {
            this.slide.nativeElement.style.height = `${poSlideDefaultHeight}px`;
            this.imageHeight = poSlideDefaultHeight;
        }
        else {
            this.imageHeight = undefined;
        }
    }
    setHeight(height) {
        if (height && height > poSlideMinHeight) {
            this.slide.nativeElement.style.height = `${height}px`;
            this.imageHeight = height;
        }
        else {
            this.setDefaultHeight(height);
        }
    }
    setSlideItemWidth() {
        if (this.hasElements) {
            this.slideItemWidth = this.itemsElements.first.itemElement.nativeElement.getBoundingClientRect().width;
        }
    }
    cancelInterval() {
        clearInterval(this.setInterval);
    }
    setSlideItems(slides) {
        if (this.hasSlides) {
            this.slideContentTemplate ? this.createArrayForTemplate(slides) : this.createArrayFromSlides(slides);
        }
        else {
            this.slideItems = [];
            this.cancelInterval();
        }
    }
    startSlide() {
        this.setSlideHeight(this.height);
        if (this.interval > poSlideIntervalMin) {
            this.startInterval();
        }
        this.currentSlideIndex = 0;
    }
    startInterval() {
        if (this.setInterval) {
            this.cancelInterval();
        }
        this.setInterval =
            this.hasSlides && this.hasElements
                ? setInterval(() => {
                    this.next();
                }, this.interval)
                : undefined;
    }
}
PoSlideComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-slide',
                template: "<div class=\"po-slide-wrapper\">\n  <div class=\"po-slide-outer\">\n    <div class=\"po-slide-inner\" #slide>\n      <ng-container *ngFor=\"let item of slideItems; let index = index\">\n        <po-slide-item\n          [p-action]=\"item.action\"\n          [p-data]=\"item\"\n          [p-image]=\"item.image\"\n          [p-image-height]=\"imageHeight\"\n          [p-template]=\"slideContentTemplate\"\n          [p-alt]=\"item.alt\"\n          [p-link]=\"item.link\"\n        >\n        </po-slide-item>\n      </ng-container>\n    </div>\n\n    <po-slide-control *ngIf=\"hasSlides && slides.length > 1\" p-control=\"previous\" (p-click)=\"previousControl()\">\n    </po-slide-control>\n\n    <po-slide-control *ngIf=\"hasSlides && slides.length > 1\" p-control=\"next\" (p-click)=\"nextControl()\">\n    </po-slide-control>\n  </div>\n\n  <po-slide-circles\n    *ngIf=\"hasSlides && slides.length > 1\"\n    [p-current-slide-index]=\"currentSlideIndex\"\n    [p-items]=\"slideItems\"\n    (p-click)=\"goToItem($event)\"\n  >\n  </po-slide-circles>\n</div>\n"
            },] }
];
PoSlideComponent.ctorParameters = () => [
    { type: AnimationBuilder }
];
PoSlideComponent.propDecorators = {
    slideContentTemplate: [{ type: ContentChild, args: [PoSlideContentTemplateDirective, { static: true },] }],
    slide: [{ type: ViewChild, args: ['slide', { static: true },] }],
    itemsElements: [{ type: ViewChildren, args: [PoSlideItemComponent,] }],
    onResize: [{ type: HostListener, args: ['window:resize',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tc2xpZGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLXNsaWRlL3BvLXNsaWRlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFlBQVksRUFFWixVQUFVLEVBQ1YsWUFBWSxFQUNaLFNBQVMsRUFDVCxTQUFTLEVBQ1QsWUFBWSxFQUdiLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQXFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVySCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUVuRyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUUvRSxNQUFNLG9CQUFvQixHQUFHLEdBQUcsQ0FBQztBQUNqQyxNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQztBQUNoQyxNQUFNLGdCQUFnQixHQUFHLEdBQUcsQ0FBQztBQUM3QixNQUFNLGFBQWEsR0FBRyxZQUFZLENBQUM7QUFFbkM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdUJHO0FBS0gsTUFBTSxPQUFPLGdCQUFpQixTQUFRLG9CQUFvQjtJQWlDeEQsWUFBb0IsT0FBeUI7UUFDM0MsS0FBSyxFQUFFLENBQUM7UUFEVSxZQUFPLEdBQVAsT0FBTyxDQUFrQjtRQWhDckMsYUFBUSxHQUFZLEtBQUssQ0FBQztRQW9CbEMsc0JBQWlCLEdBQUcsQ0FBQyxDQUFDO1FBRXRCLGVBQVUsR0FBNkIsRUFBRSxDQUFDO0lBWTFDLENBQUM7SUE5QkQsSUFBWSxXQUFXO1FBQ3JCLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENB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QzthQUN6Qzs7O1lBdkNpQixnQkFBZ0I7OzttQ0FrRS9CLFlBQVksU0FBQywrQkFBK0IsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7b0JBRzlELFNBQVMsU0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzRCQUVuQyxZQUFZLFNBQUMsb0JBQW9CO3VCQU1qQyxZQUFZLFNBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgQ29udGVudENoaWxkLFxuICBEb0NoZWNrLFxuICBFbGVtZW50UmVmLFxuICBIb3N0TGlzdGVuZXIsXG4gIFF1ZXJ5TGlzdCxcbiAgVmlld0NoaWxkLFxuICBWaWV3Q2hpbGRyZW4sXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgYW5pbWF0ZSwgQW5pbWF0aW9uQnVpbGRlciwgQW5pbWF0aW9uRmFjdG9yeSwgQW5pbWF0aW9uUGxheWVyLCBrZXlmcmFtZXMsIHN0eWxlIH0gZnJvbSAnQGFuZ3VsYXIvYW5pbWF0aW9ucyc7XG5cbmltcG9ydCB7IFBvU2xpZGVCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1zbGlkZS1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb1NsaWRlQ29udGVudFRlbXBsYXRlRGlyZWN0aXZlIH0gZnJvbSAnLi9kaXJlY3RpdmVzL3BvLXNsaWRlLWNvbnRlbnQtdGVtcGxhdGUuZGlyZWN0aXZlJztcbmltcG9ydCB7IFBvU2xpZGVJdGVtIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3BvLXNsaWRlLWl0ZW0uaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvU2xpZGVJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi9wby1zbGlkZS1pdGVtL3BvLXNsaWRlLWl0ZW0uY29tcG9uZW50JztcblxuY29uc3QgcG9TbGlkZURlZmF1bHRIZWlnaHQgPSAzMzY7XG5jb25zdCBwb1NsaWRlSW50ZXJ2YWxNaW4gPSAxMDAwO1xuY29uc3QgcG9TbGlkZU1pbkhlaWdodCA9IDE5MjtcbmNvbnN0IHBvU2xpZGVUaW1pbmcgPSAnMjUwbXMgZWFzZSc7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFBvU2xpZGVCYXNlQ29tcG9uZW50XG4gKlxuICogQGV4YW1wbGVcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zbGlkZS1iYXNpY1wiIHRpdGxlPVwiUE8gU2xpZGUgQmFzaWNcIj5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zbGlkZS1iYXNpYy9zYW1wbGUtcG8tc2xpZGUtYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXNsaWRlLWJhc2ljL3NhbXBsZS1wby1zbGlkZS1iYXNpYy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zbGlkZS1sYWJzXCIgdGl0bGU9XCJQTyBTbGlkZSBMYWJzXCI+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc2xpZGUtbGFicy9zYW1wbGUtcG8tc2xpZGUtbGFicy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc2xpZGUtbGFicy9zYW1wbGUtcG8tc2xpZGUtbGFicy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zbGlkZS11c2VmdWwtYXJ0aWNsZXNcIiB0aXRsZT1cIlBPIFNsaWRlIC0gVXNlZnVsIGFydGljbGVzXCI+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc2xpZGUtdXNlZnVsLWFydGljbGVzL3NhbXBsZS1wby1zbGlkZS11c2VmdWwtYXJ0aWNsZXMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXNsaWRlLXVzZWZ1bC1hcnRpY2xlcy9zYW1wbGUtcG8tc2xpZGUtdXNlZnVsLWFydGljbGVzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLXNsaWRlLWxhbmRzY2FwZXNcIiB0aXRsZT1cIlBPIFNsaWRlIC0gTGFuZHNjYXBlc1wiPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXNsaWRlLWxhbmRzY2FwZXMvc2FtcGxlLXBvLXNsaWRlLWxhbmRzY2FwZXMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXNsaWRlLWxhbmRzY2FwZXMvc2FtcGxlLXBvLXNsaWRlLWxhbmRzY2FwZXMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tc2xpZGUnLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tc2xpZGUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvU2xpZGVDb21wb25lbnQgZXh0ZW5kcyBQb1NsaWRlQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIERvQ2hlY2ssIE9uQ2hhbmdlcyB7XG4gIHByaXZhdGUgaXNMb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBwbGF5ZXI6IEFuaW1hdGlvblBsYXllcjtcbiAgcHJpdmF0ZSBzZXRJbnRlcnZhbDogYW55O1xuXG4gIHByaXZhdGUgZ2V0IGhhc0VsZW1lbnRzKCkge1xuICAgIHJldHVybiAhIXRoaXMuc2xpZGUubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aCAmJiAhIXRoaXMuaXRlbXNFbGVtZW50cyAmJiAhIXRoaXMuaXRlbXNFbGVtZW50cy5sZW5ndGg7XG4gIH1cblxuICBwcml2YXRlIGdldCBpc0ltYWdlU2xpZGUoKSB7XG4gICAgcmV0dXJuICF0aGlzLnNsaWRlQ29udGVudFRlbXBsYXRlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgb2Zmc2V0KCkge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRTbGlkZUluZGV4ICogdGhpcy5zbGlkZUl0ZW1XaWR0aDtcbiAgfVxuXG4gIGdldCBoYXNTbGlkZXMoKSB7XG4gICAgcmV0dXJuICEhdGhpcy5zbGlkZXMgJiYgISF0aGlzLnNsaWRlcy5sZW5ndGg7XG4gIH1cblxuICBjdXJyZW50U2xpZGVJbmRleCA9IDA7XG4gIGltYWdlSGVpZ2h0OiBudW1iZXI7XG4gIHNsaWRlSXRlbXM6IEFycmF5PFBvU2xpZGVJdGVtIHwgYW55PiA9IFtdO1xuICBzbGlkZUl0ZW1XaWR0aDogbnVtYmVyO1xuXG4gIEBDb250ZW50Q2hpbGQoUG9TbGlkZUNvbnRlbnRUZW1wbGF0ZURpcmVjdGl2ZSwgeyBzdGF0aWM6IHRydWUgfSlcbiAgc2xpZGVDb250ZW50VGVtcGxhdGU6IFBvU2xpZGVDb250ZW50VGVtcGxhdGVEaXJlY3RpdmU7XG5cbiAgQFZpZXdDaGlsZCgnc2xpZGUnLCB7IHN0YXRpYzogdHJ1ZSB9KSBwcml2YXRlIHNsaWRlOiBFbGVtZW50UmVmO1xuXG4gIEBWaWV3Q2hpbGRyZW4oUG9TbGlkZUl0ZW1Db21wb25lbnQpIHByaXZhdGUgaXRlbXNFbGVtZW50czogUXVlcnlMaXN0PFBvU2xpZGVJdGVtQ29tcG9uZW50PjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGJ1aWxkZXI6IEFuaW1hdGlvbkJ1aWxkZXIpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignd2luZG93OnJlc2l6ZScpIG9uUmVzaXplKCkge1xuICAgIGlmICh0aGlzLnNsaWRlKSB7XG4gICAgICB0aGlzLnNldFNsaWRlSXRlbVdpZHRoKCk7XG4gICAgICB0aGlzLmdvVG9JdGVtKHRoaXMuY3VycmVudFNsaWRlSW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIG5nRG9DaGVjaygpIHtcbiAgICBpZiAoIXRoaXMuaXNMb2FkZWQgJiYgdGhpcy5oYXNFbGVtZW50cykge1xuICAgICAgdGhpcy5zZXRTbGlkZUl0ZW1XaWR0aCgpO1xuICAgICAgdGhpcy5pc0xvYWRlZCA9IHRydWU7XG5cbiAgICAgIGlmICh0aGlzLmhhc1NsaWRlcykge1xuICAgICAgICB0aGlzLnN0YXJ0U2xpZGUoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuaGVpZ2h0KSB7XG4gICAgICB0aGlzLnNldFNsaWRlSGVpZ2h0KHRoaXMuaGVpZ2h0KTtcbiAgICB9XG4gIH1cblxuICBnb1RvSXRlbShpbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKHRoaXMuaW50ZXJ2YWwgPiBwb1NsaWRlSW50ZXJ2YWxNaW4pIHtcbiAgICAgIHRoaXMuc3RhcnRJbnRlcnZhbCgpO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudFNsaWRlSW5kZXggPSBpbmRleDtcbiAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xuICB9XG5cbiAgbmV4dENvbnRyb2woKSB7XG4gICAgaWYgKHRoaXMuaW50ZXJ2YWwgPiBwb1NsaWRlSW50ZXJ2YWxNaW4pIHtcbiAgICAgIHRoaXMuc3RhcnRJbnRlcnZhbCgpO1xuICAgIH1cblxuICAgIHRoaXMubmV4dCgpO1xuICB9XG5cbiAgbmV4dCgpIHtcbiAgICBpZiAodGhpcy5jdXJyZW50U2xpZGVJbmRleCArIDEgPT09IHRoaXMuc2xpZGVJdGVtcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuY3VycmVudFNsaWRlSW5kZXggPSAwO1xuICAgICAgdGhpcy5hbmltYXRlKDApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnRTbGlkZUluZGV4ID0gKHRoaXMuY3VycmVudFNsaWRlSW5kZXggKyAxKSAlIHRoaXMuc2xpZGVJdGVtcy5sZW5ndGg7XG4gICAgdGhpcy5hbmltYXRlKHRoaXMub2Zmc2V0KTtcbiAgfVxuXG4gIHByZXZpb3VzKCkge1xuICAgIGlmICh0aGlzLmN1cnJlbnRTbGlkZUluZGV4ID09PSAwKSB7XG4gICAgICB0aGlzLmN1cnJlbnRTbGlkZUluZGV4ID0gdGhpcy5zbGlkZUl0ZW1zLmxlbmd0aCAtIDE7XG4gICAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmN1cnJlbnRTbGlkZUluZGV4ID0gKHRoaXMuY3VycmVudFNsaWRlSW5kZXggLSAxICsgdGhpcy5zbGlkZUl0ZW1zLmxlbmd0aCkgJSB0aGlzLnNsaWRlSXRlbXMubGVuZ3RoO1xuICAgIHRoaXMuYW5pbWF0ZSh0aGlzLm9mZnNldCk7XG4gIH1cblxuICBwcmV2aW91c0NvbnRyb2woKSB7XG4gICAgaWYgKHRoaXMuaW50ZXJ2YWwgPiBwb1NsaWRlSW50ZXJ2YWxNaW4pIHtcbiAgICAgIHRoaXMuc3RhcnRJbnRlcnZhbCgpO1xuICAgIH1cblxuICAgIHRoaXMucHJldmlvdXMoKTtcbiAgfVxuXG4gIHNldFNsaWRlSGVpZ2h0KGhlaWdodDogbnVtYmVyKSB7XG4gICAgdGhpcy5zZXRIZWlnaHQoaGVpZ2h0KTtcbiAgfVxuXG4gIHByaXZhdGUgYW5pbWF0ZShvZmZzZXQ6IG51bWJlcikge1xuICAgIGlmICh0aGlzLmhhc0VsZW1lbnRzKSB7XG4gICAgICBjb25zdCBhbmltYXRpb246IEFuaW1hdGlvbkZhY3RvcnkgPSB0aGlzLmJ1aWxkVHJhbnNpdGlvbkFuaW1hdGlvbihvZmZzZXQpO1xuXG4gICAgICB0aGlzLnBsYXllciA9IGFuaW1hdGlvbi5jcmVhdGUodGhpcy5zbGlkZS5uYXRpdmVFbGVtZW50KTtcbiAgICAgIHRoaXMucGxheWVyLnBsYXkoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkVHJhbnNpdGlvbkFuaW1hdGlvbihvZmZzZXQ6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmJ1aWxkZXIuYnVpbGQoW2FuaW1hdGUocG9TbGlkZVRpbWluZywga2V5ZnJhbWVzKFtzdHlsZSh7IHRyYW5zZm9ybTogYHRyYW5zbGF0ZVgoLSR7b2Zmc2V0fXB4KWAgfSldKSldKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQXJyYXlGb3JUZW1wbGF0ZShzbGlkZXM6IEFycmF5PGFueT4pIHtcbiAgICB0aGlzLnNsaWRlSXRlbXMgPSBbLi4uc2xpZGVzXTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQXJyYXlGcm9tU2xpZGVzKHNsaWRlczogQXJyYXk8UG9TbGlkZUl0ZW0gfCBzdHJpbmcgfCBhbnk+KSB7XG4gICAgY29uc3QgaXNTdHJpbmdBcnJheSA9IHNsaWRlcy5ldmVyeShpdGVtID0+IHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJyk7XG5cbiAgICBpZiAoaXNTdHJpbmdBcnJheSkge1xuICAgICAgc2xpZGVzLmZvckVhY2goZWxlbWVudCA9PiB0aGlzLnNsaWRlSXRlbXMucHVzaCh7IGltYWdlOiBgJHtlbGVtZW50fWAgfSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNsaWRlSXRlbXMgPSBbLi4uKDxBcnJheTxQb1NsaWRlSXRlbT4+c2xpZGVzKV07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXREZWZhdWx0SGVpZ2h0KGhlaWdodDogbnVtYmVyKSB7XG4gICAgaWYgKChoZWlnaHQgJiYgaGVpZ2h0IDw9IHBvU2xpZGVNaW5IZWlnaHQpIHx8ICghaGVpZ2h0ICYmIHRoaXMuaXNJbWFnZVNsaWRlKSkge1xuICAgICAgdGhpcy5zbGlkZS5uYXRpdmVFbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke3BvU2xpZGVEZWZhdWx0SGVpZ2h0fXB4YDtcbiAgICAgIHRoaXMuaW1hZ2VIZWlnaHQgPSBwb1NsaWRlRGVmYXVsdEhlaWdodDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5pbWFnZUhlaWdodCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldEhlaWdodChoZWlnaHQ6IG51bWJlcikge1xuICAgIGlmIChoZWlnaHQgJiYgaGVpZ2h0ID4gcG9TbGlkZU1pbkhlaWdodCkge1xuICAgICAgdGhpcy5zbGlkZS5uYXRpdmVFbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XG4gICAgICB0aGlzLmltYWdlSGVpZ2h0ID0gaGVpZ2h0O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldERlZmF1bHRIZWlnaHQoaGVpZ2h0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldFNsaWRlSXRlbVdpZHRoKCkge1xuICAgIGlmICh0aGlzLmhhc0VsZW1lbnRzKSB7XG4gICAgICB0aGlzLnNsaWRlSXRlbVdpZHRoID0gdGhpcy5pdGVtc0VsZW1lbnRzLmZpcnN0Lml0ZW1FbGVtZW50Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGg7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGNhbmNlbEludGVydmFsKCkge1xuICAgIGNsZWFySW50ZXJ2YWwodGhpcy5zZXRJbnRlcnZhbCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2V0U2xpZGVJdGVtcyhzbGlkZXM6IEFycmF5PFBvU2xpZGVJdGVtIHwgc3RyaW5nIHwgYW55Pikge1xuICAgIGlmICh0aGlzLmhhc1NsaWRlcykge1xuICAgICAgdGhpcy5zbGlkZUNvbnRlbnRUZW1wbGF0ZSA/IHRoaXMuY3JlYXRlQXJyYXlGb3JUZW1wbGF0ZShzbGlkZXMpIDogdGhpcy5jcmVhdGVBcnJheUZyb21TbGlkZXMoc2xpZGVzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zbGlkZUl0ZW1zID0gW107XG4gICAgICB0aGlzLmNhbmNlbEludGVydmFsKCk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHN0YXJ0U2xpZGUoKSB7XG4gICAgdGhpcy5zZXRTbGlkZUhlaWdodCh0aGlzLmhlaWdodCk7XG5cbiAgICBpZiAodGhpcy5pbnRlcnZhbCA+IHBvU2xpZGVJbnRlcnZhbE1pbikge1xuICAgICAgdGhpcy5zdGFydEludGVydmFsKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50U2xpZGVJbmRleCA9IDA7XG4gIH1cblxuICBwcm90ZWN0ZWQgc3RhcnRJbnRlcnZhbCgpIHtcbiAgICBpZiAodGhpcy5zZXRJbnRlcnZhbCkge1xuICAgICAgdGhpcy5jYW5jZWxJbnRlcnZhbCgpO1xuICAgIH1cblxuICAgIHRoaXMuc2V0SW50ZXJ2YWwgPVxuICAgICAgdGhpcy5oYXNTbGlkZXMgJiYgdGhpcy5oYXNFbGVtZW50c1xuICAgICAgICA/IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubmV4dCgpO1xuICAgICAgICAgIH0sIHRoaXMuaW50ZXJ2YWwpXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICB9XG59XG4iXX0=