import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { PoComponentInjectorService } from '../../services/po-component-injector/po-component-injector.service';
import { PoLoadingOverlayComponent } from '../../components/po-loading/po-loading-overlay/po-loading-overlay.component';
import { PoHttpRequesControltService } from './po-http-request-control-service';
import * as i0 from "@angular/core";
import * as i1 from "./po-http-request-control-service";
import * as i2 from "../../services/po-component-injector/po-component-injector.service";
const noCountPendingRequests = 'X-PO-No-Count-Pending-Requests';
const screenLock = 'X-PO-Screen-Lock';
/**
 * @description
 *
 * O serviço PO Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-PO-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `PoHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-PO-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-PO-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-PO-No-Count-Pending-Requests': true, 'X-PO-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: PoHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * @example
 * <example name='po-http-request-interceptor-labs' title='PO Http Request Interceptor Labs'>
 *  <file name='sample-po-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-po-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
export class PoHttpRequestInterceptorService {
    constructor(controlHttpRequest, poComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.poComponentInjector = poComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    intercept(request, next) {
        const requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.setCountPendingRequests(false, requestClone);
                this.setCountOverlayRequests(false, requestClone);
            }
        }), catchError(error => {
            this.setCountPendingRequests(false, requestClone);
            this.setCountOverlayRequests(false, requestClone);
            return throwError(error);
        }));
    }
    getCountPendingRequests() {
        return this.controlHttpRequest.getControlHttpRequest();
    }
    buildLoading() {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.poComponentInjector.createComponentInApplication(PoLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    }
    destroyLoading() {
        if (this.loadingOverlayComponent) {
            this.poComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    }
    requestCloneWithoutHeaderParam(headersParams, request) {
        let isRequestClone = false;
        headersParams.forEach(headerParam => {
            if (request.headers.has(headerParam)) {
                request.headers.delete(headerParam);
                isRequestClone = true;
            }
        });
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    }
    setCountPendingRequests(isIncrement, request) {
        const hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        const headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && headerParam.toString().toLowerCase() === 'true') {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    }
    setCountOverlayRequests(isIncrement, request) {
        const hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            const headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    }
}
PoHttpRequestInterceptorService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PoHttpRequestInterceptorService_Factory() { return new PoHttpRequestInterceptorService(i0.ɵɵinject(i1.PoHttpRequesControltService), i0.ɵɵinject(i2.PoComponentInjectorService)); }, token: PoHttpRequestInterceptorService, providedIn: "root" });
PoHttpRequestInterceptorService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
PoHttpRequestInterceptorService.ctorParameters = () => [
    { type: PoHttpRequesControltService },
    { type: PoComponentInjectorService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2ludGVyY2VwdG9ycy9wby1odHRwLXJlcXVlc3QvcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUF3RCxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUUxRyxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sb0VBQW9FLENBQUM7QUFDaEgsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sNkVBQTZFLENBQUM7QUFFeEgsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7Ozs7QUFFaEYsTUFBTSxzQkFBc0IsR0FBRyxnQ0FBZ0MsQ0FBQztBQUNoRSxNQUFNLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQztBQUV0Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtGRztBQUlILE1BQU0sT0FBTywrQkFBK0I7SUFNMUMsWUFDVSxrQkFBK0MsRUFDL0MsbUJBQStDO1FBRC9DLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBNkI7UUFDL0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE0QjtRQVBqRCw0QkFBdUIsR0FBNEMsU0FBUyxDQUFDO1FBRTdFLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO1FBQzVCLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO0lB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UUFFaEUsSUFBSSxpQ0FBaUMsSUFBSSxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxFQUFFO1lBQ3hGLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxlQUFlLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxXQUFvQixFQUFFLE9BQXlCO1FBQzdFLE1BQU0sNEJBQTRCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFckUsSUFBSSw0QkFBNEIsRUFBRTtZQUNoQyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUVwRCxJQUFJLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxPQUFPLEVBQUU7Z0JBQ3BELE9BQU87YUFDUjtZQUVELElBQUksQ0FBQyxlQUFlLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUN4RTtJQUNILENBQUM7Ozs7WUEvRkYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUExRlEsMkJBQTJCO1lBSDNCLDBCQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEV2ZW50LCBIdHRwSGFuZGxlciwgSHR0cEludGVyY2VwdG9yLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tY29tcG9uZW50LWluamVjdG9yL3BvLWNvbXBvbmVudC1pbmplY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7IFBvTG9hZGluZ092ZXJsYXlDb21wb25lbnQgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL3BvLWxvYWRpbmcvcG8tbG9hZGluZy1vdmVybGF5L3BvLWxvYWRpbmctb3ZlcmxheS5jb21wb25lbnQnO1xuXG5pbXBvcnQgeyBQb0h0dHBSZXF1ZXNDb250cm9sdFNlcnZpY2UgfSBmcm9tICcuL3BvLWh0dHAtcmVxdWVzdC1jb250cm9sLXNlcnZpY2UnO1xuXG5jb25zdCBub0NvdW50UGVuZGluZ1JlcXVlc3RzID0gJ1gtUE8tTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc7XG5jb25zdCBzY3JlZW5Mb2NrID0gJ1gtUE8tU2NyZWVuLUxvY2snO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gc2VydmnDp28gUE8gSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIHJlYWxpemEgYSBjb250YWJpbGl6YcOnw6NvIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzIG5hIGFwbGljYcOnw6NvLlxuICpcbiAqIEV4aXN0ZSBhIHBvc3NpYmlsaWRhZGUgZGUgbsOjbyBlZmV0dWFyIGEgY29udGFiaWxpemHDp8OjbyBkYXMgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMsIHV0aWxpemFuZG8gbyBwYXLDom1ldHJvXG4gKiBgWC1QTy1Oby1Db3VudC1QZW5kaW5nLVJlcXVlc3RzYC4gUGFyYSBpc3NvIGRldmUgc2VyIGluZm9ybWFkbyBubyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8OjbyBjb20gbyB2YWxvciBgJ3RydWUnYCxcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqIFBhcmEgb2J0ZXIgYSBxdWFudGlkYWRlIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLCBkZXZlIGluc2NyZXZlci1zZSBubyBtw6l0b2RvIGBnZXRDb3VudFBlbmRpbmdSZXF1ZXN0c2AgZG9cbiAqIHNlcnZpw6dvIGBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlYCwgY29tIGlzc28sIGFvIHJlYWxpemFyIHJlcXVpc2nDp8O1ZXMgdXRpbGl6YW5kbyBgSHR0cENsaWVudGAsXG4gKiBzZXLDoSByZXRvcm5hZG8gYSBxdWFudGlkYWRlIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLlxuICpcbiAqIFRhbWLDqW0gZXhpc3RlIGEgcG9zc2liaWxkYWRlIGRlIHRyYXZhciBhIHRlbGEgZSBtb3N0cmFyIHVtYSBpbWFnZW0gZGUgX2xvYWRpbmdfIGR1cmFudGUgbyBwcm9jZXNzYW1lbnRvIGRlIHVtYSByZXF1aXNpw6fDo29cbiAqIGRldmUtc2UgcGFzc2FyIG8gcGFyw6JtZXRybyBgWC1QTy1TY3JlZW4tTG9ja2Agbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gY29tIHZhbG9yIGAndHJ1ZSdgLlxuICpcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tU2NyZWVuLUxvY2snOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKiA+IEFww7NzIGEgdmFsaWRhw6fDo28gbm8gaW50ZXJjZXB0b3IsIG8gcGFyw6JtZXRybyBzZXLDoSByZW1vdmlkbyBkbyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8Ojby5cbiAqXG4gKiBBbyBpbXBvcnRhciBvIG3Ds2R1bG8gYFBvTW9kdWxlYCBuYSBhcGxpY2HDp8OjbywgbyBgcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yYCDDqSBhdXRvbWF0aWNhbWVudGUgY29uZmlndXJhZG8gc2VtIGEgbmVjZXNzaWRhZGVcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxuICpcbiAqXG4gKiBTZWd1ZSBhYmFpeG8gdW0gZXhlbXBsbyBkZSB1c286XG4gKlxuICogYGBgXG4gKiBpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuICpcbiAqIC4uLlxuICpcbiAqIEBJbmplY3RhYmxlKClcbiAqIGV4cG9ydCBjbGFzcyBDdXN0b21lcnNTZXJ2aWNlIHtcbiAqXG4gKiAgaGVhZGVycyA9IHsgJ1gtUE8tTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6IHRydWUsICdYLVBPLVNjcmVlbi1Mb2NrJzogJ3RydWUnIH1cbiAqICBwZW5kaW5nUmVxdWVzdHM6IG51bWJlciA9IDA7XG4gKiAgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gKlxuICogIGNvbnN0cnVjdG9yKFxuICogICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICogICAgcHJpdmF0ZSBodHRwUmVxdWVzdEludGVyY2VwdG9yOiBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlKSB7IH1cbiAqXG4gKiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gKiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICogIH1cbiAqXG4gKiAgbmdPbkluaXQoKTogdm9pZCB7XG4gKiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuaHR0cFJlcXVlc3RJbnRlcmNlcHRvci5nZXRDb3VudFBlbmRpbmdSZXF1ZXN0cygpLnN1YnNjcmliZShkYXRhID0+IHtcbiAqICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMgPSBkYXRhO1xuICogICAgfSk7XG4gKiAgfVxuICpcbiAqICBnZXRDdXN0b21lcnMoKSB7XG4gKiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogIH1cbiAqXG4gKiAgLi4uXG4gKlxuICogfVxuICogYGBgXG4gKlxuICogQGV4YW1wbGVcbiAqIDxleGFtcGxlIG5hbWU9J3BvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzJyB0aXRsZT0nUE8gSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIExhYnMnPlxuICogIDxmaWxlIG5hbWU9J3NhbXBsZS1wby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicy5jb21wb25lbnQudHMnPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT0nc2FtcGxlLXBvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzLmNvbXBvbmVudC5odG1sJz4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcbiAgcHJpdmF0ZSBsb2FkaW5nT3ZlcmxheUNvbXBvbmVudDogQ29tcG9uZW50UmVmPFBvTG9hZGluZ092ZXJsYXlDb21wb25lbnQ+ID0gdW5kZWZpbmVkO1xuXG4gIHByaXZhdGUgcGVuZGluZ1JlcXVlc3RzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIG92ZXJsYXlSZXF1ZXN0czogbnVtYmVyID0gMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvbnRyb2xIdHRwUmVxdWVzdDogUG9IdHRwUmVxdWVzQ29udHJvbHRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcG9Db21wb25lbnRJbmplY3RvcjogUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2VcbiAgKSB7fVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcikge1xuICAgIGNvbnN0IHJlcXVlc3RDbG9uZSA9IHJlcXVlc3QuY2xvbmUoKTtcblxuICAgIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RDbG9uZVdpdGhvdXRIZWFkZXJQYXJhbShbbm9Db3VudFBlbmRpbmdSZXF1ZXN0cywgc2NyZWVuTG9ja10sIHJlcXVlc3QpO1xuXG4gICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyh0cnVlLCByZXF1ZXN0Q2xvbmUpO1xuICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHModHJ1ZSwgcmVxdWVzdENsb25lKTtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgdGFwKChyZXNwb25zZTogSHR0cEV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcbiAgICAgICAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xuICAgICAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGdldENvdW50UGVuZGluZ1JlcXVlc3RzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbEh0dHBSZXF1ZXN0LmdldENvbnRyb2xIdHRwUmVxdWVzdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZExvYWRpbmcoKSB7XG4gICAgaWYgKCF0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KSB7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50ID0gdGhpcy5wb0NvbXBvbmVudEluamVjdG9yLmNyZWF0ZUNvbXBvbmVudEluQXBwbGljYXRpb24oUG9Mb2FkaW5nT3ZlcmxheUNvbXBvbmVudCk7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50Lmluc3RhbmNlLnNjcmVlbkxvY2sgPSB0cnVlO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudC5pbnN0YW5jZS5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95TG9hZGluZygpIHtcbiAgICBpZiAodGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCkge1xuICAgICAgdGhpcy5wb0NvbXBvbmVudEluamVjdG9yLmRlc3Ryb3lDb21wb25lbnRJbkFwcGxpY2F0aW9uKHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlcXVlc3RDbG9uZVdpdGhvdXRIZWFkZXJQYXJhbShoZWFkZXJzUGFyYW1zOiBBcnJheTxzdHJpbmc+LCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSHR0cFJlcXVlc3Q8YW55PiB7XG4gICAgbGV0IGlzUmVxdWVzdENsb25lID0gZmFsc2U7XG5cbiAgICBoZWFkZXJzUGFyYW1zLmZvckVhY2goaGVhZGVyUGFyYW0gPT4ge1xuICAgICAgaWYgKHJlcXVlc3QuaGVhZGVycy5oYXMoaGVhZGVyUGFyYW0pKSB7XG4gICAgICAgIHJlcXVlc3QuaGVhZGVycy5kZWxldGUoaGVhZGVyUGFyYW0pO1xuICAgICAgICBpc1JlcXVlc3RDbG9uZSA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gaXNSZXF1ZXN0Q2xvbmUgPyByZXF1ZXN0LmNsb25lKHsgaGVhZGVyczogcmVxdWVzdC5oZWFkZXJzIH0pIDogcmVxdWVzdDtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoaXNJbmNyZW1lbnQ6IGJvb2xlYW4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBoYXNDb3VudFBlbmRpbmdSZXF1ZXN0SGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuaGFzKG5vQ291bnRQZW5kaW5nUmVxdWVzdHMpO1xuICAgIGNvbnN0IGhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmdldChub0NvdW50UGVuZGluZ1JlcXVlc3RzKTtcblxuICAgIGlmIChoYXNDb3VudFBlbmRpbmdSZXF1ZXN0SGVhZGVyUGFyYW0gJiYgaGVhZGVyUGFyYW0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZScpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cyArPSBpc0luY3JlbWVudCA/IDEgOiAtMTtcbiAgICB0aGlzLmNvbnRyb2xIdHRwUmVxdWVzdC5zZW5kKHRoaXMucGVuZGluZ1JlcXVlc3RzKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q291bnRPdmVybGF5UmVxdWVzdHMoaXNJbmNyZW1lbnQ6IGJvb2xlYW4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBoYXNPdmVybGF5UmVxdWVzdEhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmhhcyhzY3JlZW5Mb2NrKTtcblxuICAgIGlmIChoYXNPdmVybGF5UmVxdWVzdEhlYWRlclBhcmFtKSB7XG4gICAgICBjb25zdCBoZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5nZXQoc2NyZWVuTG9jayk7XG5cbiAgICAgIGlmIChoZWFkZXJQYXJhbS50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkgPT09ICdmYWxzZScpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLm92ZXJsYXlSZXF1ZXN0cyArPSBpc0luY3JlbWVudCA/IDEgOiAtMTtcbiAgICAgIHRoaXMub3ZlcmxheVJlcXVlc3RzID4gMCA/IHRoaXMuYnVpbGRMb2FkaW5nKCkgOiB0aGlzLmRlc3Ryb3lMb2FkaW5nKCk7XG4gICAgfVxuICB9XG59XG4iXX0=